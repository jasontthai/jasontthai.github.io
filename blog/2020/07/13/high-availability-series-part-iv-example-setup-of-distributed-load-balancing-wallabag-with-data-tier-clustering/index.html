<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 --><title>[High Availability Series] PART IV: Example Setup of Distributed Load Balancing Wallabag with Data Tier Clustering | Jason’s Notes</title><meta name="generator" content="Jekyll v3.8.7" /><meta property="og:title" content="[High Availability Series] PART IV: Example Setup of Distributed Load Balancing Wallabag with Data Tier Clustering" /><meta name="author" content="Jason Thai" /><meta property="og:locale" content="en_US" /><meta name="description" content="High Availability Series: Example Setup of Distributed Load Balancing Wallabag with Data Tier Clustering. How to set up a highly available Wallabag with docker-compose powered by HAProxy and Galera cluster." /><meta property="og:description" content="High Availability Series: Example Setup of Distributed Load Balancing Wallabag with Data Tier Clustering. How to set up a highly available Wallabag with docker-compose powered by HAProxy and Galera cluster." /><link rel="canonical" href="https://jasonthai.me/blog/2020/07/13/high-availability-series-part-iv-example-setup-of-distributed-load-balancing-wallabag-with-data-tier-clustering/" /><meta property="og:url" content="https://jasonthai.me/blog/2020/07/13/high-availability-series-part-iv-example-setup-of-distributed-load-balancing-wallabag-with-data-tier-clustering/" /><meta property="og:site_name" content="Jason’s Notes" /><meta property="og:image" content="https://jasonthai.me/assets/img/ha-cluster.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-07-13T00:00:00+00:00" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"https://jasonthai.me/blog/2020/07/13/high-availability-series-part-iv-example-setup-of-distributed-load-balancing-wallabag-with-data-tier-clustering/","headline":"[High Availability Series] PART IV: Example Setup of Distributed Load Balancing Wallabag with Data Tier Clustering","dateModified":"2020-07-13T00:00:00+00:00","datePublished":"2020-07-13T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jasonthai.me/blog/2020/07/13/high-availability-series-part-iv-example-setup-of-distributed-load-balancing-wallabag-with-data-tier-clustering/"},"image":"https://jasonthai.me/assets/img/ha-cluster.png","author":{"@type":"Person","name":"Jason Thai"},"description":"High Availability Series: Example Setup of Distributed Load Balancing Wallabag with Data Tier Clustering. How to set up a highly available Wallabag with docker-compose powered by HAProxy and Galera cluster.","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --><link rel="stylesheet" href="/assets/css/style.css"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" href="/assets/img/apple-touch-icon.png"><meta name="theme-color" content="#fff" /><link type="application/atom+xml" rel="alternate" href="https://jasonthai.me/feed.xml" title="Jason's Notes" /><!-- <script src="/assets/js/lazysizes.min.js" async=""></script> --> <!-- <script src="/assets/js/ls.unveilhooks.min.js" async=""></script> --> <script type="text/javascript"> /*! lazysizes - v5.1.0 */ !function(a,b){var c=b(a,a.document);a.lazySizes=c,"object"==typeof module&&module.exports&&(module.exports=c)}("undefined"!=typeof window?window:{},function(a,b){"use strict";var c,d;if(function(){var b,c={lazyClass:"lazyload",loadedClass:"lazyloaded",loadingClass:"lazyloading",preloadClass:"lazypreload",errorClass:"lazyerror",autosizesClass:"lazyautosizes",srcAttr:"data-src",srcsetAttr:"data-srcset",sizesAttr:"data-sizes",minSize:40,customMedia:{},init:!0,expFactor:1.5,hFac:.8,loadMode:2,loadHidden:!0,ricTimeout:0,throttleDelay:125};d=a.lazySizesConfig||a.lazysizesConfig||{};for(b in c)b in d||(d[b]=c[b])}(),!b||!b.getElementsByClassName)return{init:function(){},cfg:d,noSupport:!0};var e=b.documentElement,f=a.Date,g=a.HTMLPictureElement,h="addEventListener",i="getAttribute",j=a[h],k=a.setTimeout,l=a.requestAnimationFrame||k,m=a.requestIdleCallback,n=/^picture$/i,o=["load","error","lazyincluded","_lazyloaded"],p={},q=Array.prototype.forEach,r=function(a,b){return p[b]||(p[b]=new RegExp("(\\s|^)"+b+"(\\s|$)")),p[b].test(a[i]("class")||"")&&p[b]},s=function(a,b){r(a,b)||a.setAttribute("class",(a[i]("class")||"").trim()+" "+b)},t=function(a,b){var c;(c=r(a,b))&&a.setAttribute("class",(a[i]("class")||"").replace(c," "))},u=function(a,b,c){var d=c?h:"removeEventListener";c&&u(a,b),o.forEach(function(c){a[d](c,b)})},v=function(a,d,e,f,g){var h=b.createEvent("Event");return e||(e={}),e.instance=c,h.initEvent(d,!f,!g),h.detail=e,a.dispatchEvent(h),h},w=function(b,c){var e;!g&&(e=a.picturefill||d.pf)?(c&&c.src&&!b[i]("srcset")&&b.setAttribute("srcset",c.src),e({reevaluate:!0,elements:[b]})):c&&c.src&&(b.src=c.src)},x=function(a,b){return(getComputedStyle(a,null)||{})[b]},y=function(a,b,c){for(c=c||a.offsetWidth;c<d.minSize&&b&&!a._lazysizesWidth;)c=b.offsetWidth,b=b.parentNode;return c},z=function(){var a,c,d=[],e=[],f=d,g=function(){var b=f;for(f=d.length?e:d,a=!0,c=!1;b.length;)b.shift()();a=!1},h=function(d,e){a&&!e?d.apply(this,arguments):(f.push(d),c||(c=!0,(b.hidden?k:l)(g)))};return h._lsFlush=g,h}(),A=function(a,b){return b?function(){z(a)}:function(){var b=this,c=arguments;z(function(){a.apply(b,c)})}},B=function(a){var b,c=0,e=d.throttleDelay,g=d.ricTimeout,h=function(){b=!1,c=f.now(),a()},i=m&&g>49?function(){m(h,{timeout:g}),g!==d.ricTimeout&&(g=d.ricTimeout)}:A(function(){k(h)},!0);return function(a){var d;(a=!0===a)&&(g=33),b||(b=!0,d=e-(f.now()-c),d<0&&(d=0),a||d<9?i():k(i,d))}},C=function(a){var b,c,d=99,e=function(){b=null,a()},g=function(){var a=f.now()-c;a<d?k(g,d-a):(m||e)(e)};return function(){c=f.now(),b||(b=k(g,d))}},D=function(){var g,l,m,o,p,y,D,F,G,H,I,J,K=/^img$/i,L=/^iframe$/i,M="onscroll"in a&&!/(gle|ing)bot/.test(navigator.userAgent),N=0,O=0,P=0,Q=-1,R=function(a){P--,(!a||P<0||!a.target)&&(P=0)},S=function(a){return null==J&&(J="hidden"==x(b.body,"visibility")),J||"hidden"!=x(a.parentNode,"visibility")&&"hidden"!=x(a,"visibility")},T=function(a,c){var d,f=a,g=S(a);for(F-=c,I+=c,G-=c,H+=c;g&&(f=f.offsetParent)&&f!=b.body&&f!=e;)(g=(x(f,"opacity")||1)>0)&&"visible"!=x(f,"overflow")&&(d=f.getBoundingClientRect(),g=H>d.left&&G<d.right&&I>d.top-1&&F<d.bottom+1);return g},U=function(){var a,f,h,j,k,m,n,p,q,r,s,t,u=c.elements;if((o=d.loadMode)&&P<8&&(a=u.length)){for(f=0,Q++;f<a;f++)if(u[f]&&!u[f]._lazyRace)if(!M||c.prematureUnveil&&c.prematureUnveil(u[f]))aa(u[f]);else if((p=u[f][i]("data-expand"))&&(m=1*p)||(m=O),r||(r=!d.expand||d.expand<1?e.clientHeight>500&&e.clientWidth>500?500:370:d.expand,c._defEx=r,s=r*d.expFactor,t=d.hFac,J=null,O<s&&P<1&&Q>2&&o>2&&!b.hidden?(O=s,Q=0):O=o>1&&Q>1&&P<6?r:N),q!==m&&(y=innerWidth+m*t,D=innerHeight+m,n=-1*m,q=m),h=u[f].getBoundingClientRect(),(I=h.bottom)>=n&&(F=h.top)<=D&&(H=h.right)>=n*t&&(G=h.left)<=y&&(I||H||G||F)&&(d.loadHidden||S(u[f]))&&(l&&P<3&&!p&&(o<3||Q<4)||T(u[f],m))){if(aa(u[f]),k=!0,P>9)break}else!k&&l&&!j&&P<4&&Q<4&&o>2&&(g[0]||d.preloadAfterLoad)&&(g[0]||!p&&(I||H||G||F||"auto"!=u[f][i](d.sizesAttr)))&&(j=g[0]||u[f]);j&&!k&&aa(j)}},V=B(U),W=function(a){var b=a.target;if(b._lazyCache)return void delete b._lazyCache;R(a),s(b,d.loadedClass),t(b,d.loadingClass),u(b,Y),v(b,"lazyloaded")},X=A(W),Y=function(a){X({target:a.target})},Z=function(a,b){try{a.contentWindow.location.replace(b)}catch(c){a.src=b}},$=function(a){var b,c=a[i](d.srcsetAttr);(b=d.customMedia[a[i]("data-media")||a[i]("media")])&&a.setAttribute("media",b),c&&a.setAttribute("srcset",c)},_=A(function(a,b,c,e,f){var g,h,j,l,o,p;(o=v(a,"lazybeforeunveil",b)).defaultPrevented||(e&&(c?s(a,d.autosizesClass):a.setAttribute("sizes",e)),h=a[i](d.srcsetAttr),g=a[i](d.srcAttr),f&&(j=a.parentNode,l=j&&n.test(j.nodeName||"")),p=b.firesLoad||"src"in a&&(h||g||l),o={target:a},s(a,d.loadingClass),p&&(clearTimeout(m),m=k(R,2500),u(a,Y,!0)),l&&q.call(j.getElementsByTagName("source"),$),h?a.setAttribute("srcset",h):g&&!l&&(L.test(a.nodeName)?Z(a,g):a.src=g),f&&(h||l)&&w(a,{src:g})),a._lazyRace&&delete a._lazyRace,t(a,d.lazyClass),z(function(){var b=a.complete&&a.naturalWidth>1;p&&!b||(b&&s(a,"ls-is-cached"),W(o),a._lazyCache=!0,k(function(){"_lazyCache"in a&&delete a._lazyCache},9)),"lazy"==a.loading&&P--},!0)}),aa=function(a){if(!a._lazyRace){var b,c=K.test(a.nodeName),e=c&&(a[i](d.sizesAttr)||a[i]("sizes")),f="auto"==e;(!f&&l||!c||!a[i]("src")&&!a.srcset||a.complete||r(a,d.errorClass)||!r(a,d.lazyClass))&&(b=v(a,"lazyunveilread").detail,f&&E.updateElem(a,!0,a.offsetWidth),a._lazyRace=!0,P++,_(a,b,f,e,c))}},ba=C(function(){d.loadMode=3,V()}),ca=function(){3==d.loadMode&&(d.loadMode=2),ba()},da=function(){if(!l){if(f.now()-p<999)return void k(da,999);l=!0,d.loadMode=3,V(),j("scroll",ca,!0)}};return{_:function(){p=f.now(),c.elements=b.getElementsByClassName(d.lazyClass),g=b.getElementsByClassName(d.lazyClass+" "+d.preloadClass),j("scroll",V,!0),j("resize",V,!0),a.MutationObserver?new MutationObserver(V).observe(e,{childList:!0,subtree:!0,attributes:!0}):(e[h]("DOMNodeInserted",V,!0),e[h]("DOMAttrModified",V,!0),setInterval(V,999)),j("hashchange",V,!0),["focus","mouseover","click","load","transitionend","animationend"].forEach(function(a){b[h](a,V,!0)}),/d$|^c/.test(b.readyState)?da():(j("load",da),b[h]("DOMContentLoaded",V),k(da,2e4)),c.elements.length?(U(),z._lsFlush()):V()},checkElems:V,unveil:aa,_aLSL:ca}}(),E=function(){var a,c=A(function(a,b,c,d){var e,f,g;if(a._lazysizesWidth=d,d+="px",a.setAttribute("sizes",d),n.test(b.nodeName||""))for(e=b.getElementsByTagName("source"),f=0,g=e.length;f<g;f++)e[f].setAttribute("sizes",d);c.detail.dataAttr||w(a,c.detail)}),e=function(a,b,d){var e,f=a.parentNode;f&&(d=y(a,f,d),e=v(a,"lazybeforesizes",{width:d,dataAttr:!!b}),e.defaultPrevented||(d=e.detail.width)&&d!==a._lazysizesWidth&&c(a,f,e,d))},f=function(){var b,c=a.length;if(c)for(b=0;b<c;b++)e(a[b])},g=C(f);return{_:function(){a=b.getElementsByClassName(d.autosizesClass),j("resize",g)},checkElems:g,updateElem:e}}(),F=function(){!F.i&&b.getElementsByClassName&&(F.i=!0,E._(),D._())};return k(function(){d.init&&F()}),c={cfg:d,autoSizer:E,loader:D,init:F,uP:w,aC:s,rC:t,hC:r,fire:v,gW:y,rAF:z}}); /*! lazysizes - v5.1.0 */ !function(a,b){var c=function(){b(a.lazySizes),a.removeEventListener("lazyunveilread",c,!0)};b=b.bind(null,a,a.document),"object"==typeof module&&module.exports?b(require("lazysizes")):a.lazySizes?c():a.addEventListener("lazyunveilread",c,!0)}(window,function(a,b,c){"use strict";function d(a,c){if(!g[a]){var d=b.createElement(c?"link":"script"),e=b.getElementsByTagName("script")[0];c?(d.rel="stylesheet",d.href=a):d.src=a,g[a]=!0,g[d.src||d.href]=!0,e.parentNode.insertBefore(d,e)}}var e,f,g={};b.addEventListener&&(f=/\(|\)|\s|'/,e=function(a,c){var d=b.createElement("img");d.onload=function(){d.onload=null,d.onerror=null,d=null,c()},d.onerror=d.onload,d.src=a,d&&d.complete&&d.onload&&d.onload()},addEventListener("lazybeforeunveil",function(a){if(a.detail.instance==c){var b,g,h,i;a.defaultPrevented||("none"==a.target.preload&&(a.target.preload="auto"),b=a.target.getAttribute("data-link"),b&&d(b,!0),b=a.target.getAttribute("data-script"),b&&d(b),b=a.target.getAttribute("data-require"),b&&(c.cfg.requireJs?c.cfg.requireJs([b]):d(b)),h=a.target.getAttribute("data-bg"),h&&(a.detail.firesLoad=!0,g=function(){a.target.style.backgroundImage="url("+(f.test(h)?JSON.stringify(h):h)+")",a.detail.firesLoad=!1,c.fire(a.target,"_lazyloaded",{},!0,!0)},e(h,g)),(i=a.target.getAttribute("data-poster"))&&(a.detail.firesLoad=!0,g=function(){a.target.poster=i,a.detail.firesLoad=!1,c.fire(a.target,"_lazyloaded",{},!0,!0)},e(i,g)))}},!1))}); </script> <script> /* Check that service workers are supported */ if ('serviceWorker' in navigator) { /* Use the window load event to keep the page load performant */ window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js'); }); } </script> <!-- Matomo --> <script type="text/javascript"> var _paq = window._paq || []; /* tracker methods like "setCustomDimension" should be called before "trackPageView" */ _paq.push(["setDocumentTitle", document.domain + "/" + document.title]); _paq.push(['trackPageView']); _paq.push(['enableLinkTracking']); _paq.push(['enableHeartBeatTimer']); (function() { var u="//analytics.jasonthai.me/"; _paq.push(['setTrackerUrl', u+'matomo.php']); _paq.push(['setSiteId', '1']); var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s); })(); </script> <noscript><p><img src="//analytics.jasonthai.me/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt="" /></p></noscript> <!-- End Matomo Code --></head><body class="flex flex-column vh-100"><header class="avenir"><nav class="db bb b--light-silver dt-l w-100 border-box pa3 ph5-l"> <a class="db dtc-l v-mid mid-gray link underline-hover w-100 w-25-l tc tl-l mb2 mb0-l f3-l" href="/" title="Home"> <img src="/favicon.png" class="v-mid w2 h2 br-100" alt="Site Name"> Jason's Notes </a><div class="db dtc-l v-mid w-100 w-75-l tc tr-l"><a class="link underline-hover dark-gray f6 f5-l dib mr3 mr4-l" href="/about/">About</a><a class="link underline-hover dark-gray f6 f5-l dib mr3 mr4-l" href="/services/">Services</a><a class="link underline-hover dark-gray f6 f5-l dib mr3 mr4-l" href="/posts/">Posts</a><a class="link underline-hover dark-gray f6 f5-l dib mr3 mr4-l" href="/categories/">Categories</a><a class="link underline-hover dark-gray f6 f5-l dib mr3 mr4-l" href="/visited-places/">Places I Visited</a></div></nav></header><main class="db h-auto w-100 ph5-l flex-grow-1" aria-label="Content"><div class="db fl-l w-100"><article class="avenir center w-two-thirds-ns w-90"><header class="pt2 pt3-ns"><h1 class="tc f1-l lh-title mt0 baskerville">[High Availability Series] PART IV: Example Setup of Distributed Load Balancing Wallabag with Data Tier Clustering</h1><time class="tc f5 f4-l db">Jul 13, 2020 </time><p class="tc f5 mb4 center lh-copy"> Jason Thai</p></header><div class=""><div class="db f5 lh-copy"><ul class="section-nav"><li class="toc-entry toc-h1"><a href="#introduction">Introduction</a></li><li class="toc-entry toc-h1"><a href="#prerequisite">Prerequisite</a></li><li class="toc-entry toc-h1"><a href="#configure-the-first-webserver-instance">Configure the first webserver instance</a><ul><li class="toc-entry toc-h2"><a href="#install-wallabag">Install Wallabag</a></li><li class="toc-entry toc-h2"><a href="#configure-apache-reverse-proxy-to-expose-wallabag-to-end-users">Configure Apache reverse proxy to expose Wallabag to end users</a></li></ul></li><li class="toc-entry toc-h1"><a href="#configure-the-second-and-third-webserver-node">Configure the second and third webserver node</a></li><li class="toc-entry toc-h1"><a href="#configure-haproxy-to-load-balance-three-webservers">Configure HAProxy to load balance three webservers</a></li><li class="toc-entry toc-h1"><a href="#configure-dns-for-your-wallabag-and-ip">Configure DNS for your Wallabag and IP</a></li><li class="toc-entry toc-h1"><a href="#conclusion">Conclusion</a></li><li class="toc-entry toc-h1"><a href="#references">References</a></li></ul><picture> <source srcset="https://jasonthai.me/assets/img/ha-cluster.webp" type="image/webp"></source> <img class="db ml-auto mr-auto" src="https://jasonthai.me/assets/img/ha-cluster.png" alt="HA Distributed Web Apps"> </picture><h1 id="introduction"> <a class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h1><blockquote><p>Wallabag is a self hostable application for saving web pages: Save and classify articles. Read them later. Freely <a href="https://wallabag.org/en">https://wallabag.org/en</a></p></blockquote><p>This post will provide an example of setting up a highly available web application. We will cover set up Wallabag using Docker Compose and configure HAProxy to load balance the multiple webservers that run Wallabag.</p><h1 id="prerequisite"> <a class="anchor" href="#prerequisite" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prerequisite</h1><p>You should have set up the Galera cluster and configured HAProxy as the load balancer for the DB nodes. As shown in the diagram, the webserver node is the same as the HAProxy node configured to communicate with Galera cluster. Refer to all the previous posts of HA Series to set them up:</p><ul><li><p><a href="https://jasonthai.me/blog/2020/06/08/high-availability-series-part-i-set-up-and-secure-mariadb-on-debian-servers/">[High Availability Series] PART I: Set Up and Use SSL to Secure MariaDB on Debian Servers</a></p></li><li><p><a href="https://jasonthai.me/blog/2020/06/20/high-availability-series-part-ii-configure-and-secure-a-3-node-galera-cluster/">[High Availability Series] PART II: Configure and Secure a 3-node Galera Cluster</a></p></li><li><p><a href="https://jasonthai.me/blog/2020/07/03/high-availability-series-part-iii-high-availability-galera-cluster-with-haproxy-and-stunnel/">[High Availability Series] PART III: High Availability Galera Cluster with HAProxy and Stunnel</a></p></li></ul><p>You should also have set up Apache2 as your web server, and installed Docker and Docker Compose:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-fsSL</span> https://get.docker.com <span class="nt">-o</span> get-docker.sh
<span class="nv">$ </span>sh get-docker.sh

<span class="nv">$ </span><span class="nb">sudo </span>curl <span class="nt">-L</span> <span class="s2">"https://github.com/docker/compose/releases/download/1.24.1/docker-compose-</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-s</span><span class="si">)</span><span class="s2">-</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="nt">-o</span> /usr/local/bin/docker-compose
<span class="nv">$ </span><span class="nb">sudo chmod</span> +x /usr/local/bin/docker-compose

<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>apache2
<span class="nv">$ </span><span class="nb">sudo </span>a2enmod ssl proxy proxy_http
</code></pre></div></div><p>Note the IP of docker0 proto on the webserver node:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ip r | <span class="nb">grep </span>docker0
172.17.0.0/16 dev docker0 proto kernel scope <span class="nb">link </span>src 172.17.0.1
</code></pre></div></div><p>The value is usually <code class="highlighter-rouge">172.17.0.1</code></p><h1 id="configure-the-first-webserver-instance"> <a class="anchor" href="#configure-the-first-webserver-instance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configure the first webserver instance</h1><h2 id="install-wallabag"> <a class="anchor" href="#install-wallabag" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install Wallabag</h2><p>Create the <code class="highlighter-rouge">docker-compose.yml</code> and add the following lines:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: <span class="s1">'2'</span>
services:
  wallabag:
    image: wallabag/wallabag
    logging:
      driver: <span class="s2">"json-file"</span>
      options:
        max-file: <span class="s2">"3"</span>
        max-size: <span class="s2">"10m"</span>
    environment:
      - <span class="nv">POPULATE_DATABASE</span><span class="o">=</span><span class="nb">false</span>
      - <span class="nv">SYMFONY__ENV__DATABASE_DRIVER</span><span class="o">=</span>pdo_mysql
      - <span class="nv">SYMFONY__ENV__DATABASE_HOST</span><span class="o">=</span>172.17.0.1
      - <span class="nv">SYMFONY__ENV__DATABASE_PORT</span><span class="o">=</span>3307
      - <span class="nv">SYMFONY__ENV__DATABASE_NAME</span><span class="o">=</span>wallabag
      - <span class="nv">SYMFONY__ENV__DATABASE_USER</span><span class="o">=</span>wallabag
      - <span class="nv">SYMFONY__ENV__DATABASE_PASSWORD</span><span class="o">=</span><span class="s2">"SOME SECURE PASSWORD"</span>
      - <span class="nv">SYMFONY__ENV__DATABASE_CHARSET</span><span class="o">=</span>utf8mb4
      - <span class="nv">SYMFONY__ENV__MAILER_HOST</span><span class="o">=</span>ENTER YOUR VALUE HERE
      - <span class="nv">SYMFONY__ENV__MAILER_USER</span><span class="o">=</span>ENTER YOUR VALUE HERE
      - <span class="nv">SYMFONY__ENV__MAILER_PASSWORD</span><span class="o">=</span>ENTER YOUR VALUE HERE
      - <span class="nv">SYMFONY__ENV__FROM_EMAIL</span><span class="o">=</span>ENTER YOUR VALUE HERE
      - <span class="nv">SYMFONY__ENV__DOMAIN_NAME</span><span class="o">=</span>ENTER YOUR VALUE HERE
      - <span class="nv">SYMFONY__ENV__FOSUSER_REGISTRATION</span><span class="o">=</span><span class="nb">false
    </span>ports:
      - 8080:80
    volumes:
      - /opt/wallabag/images:/var/www/wallabag/web/assets/images
    restart: always
    network_mode: bridge
</code></pre></div></div><p>Explanation of a few options:</p><ul><li> <strong>SYMFONYENVDATABASE_HOST=172.17.0.1</strong> - The IP of docker0 proto we noted earlier. This tells docker to talk to the localhost mysql instance. Why not <code class="highlighter-rouge">127.0.0.1</code> ? Because docker communicates in its own subnet and <code class="highlighter-rouge">127.0.0.1</code> does not mean localhost.</li><li> <strong>SYMFONYENVDATABASE_PORT=3307</strong> - As previously configured, <code class="highlighter-rouge">3307</code> is the port we expose through HAProxy to talk to our Galera cluster</li><li> <strong>network_mode: bridge</strong> - Configure the network mode in order for docker to talk to local mysql on the webserver node.</li></ul><p>Start the container:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose up <span class="nt">-d</span>
</code></pre></div></div><h2 id="configure-apache-reverse-proxy-to-expose-wallabag-to-end-users"> <a class="anchor" href="#configure-apache-reverse-proxy-to-expose-wallabag-to-end-users" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configure Apache reverse proxy to expose Wallabag to end users</h2><p>The domain I use is <a href="http://wallabag.jasonthai.me">https://wallabag.jasonthai.me</a>, you can change this to your own one.</p><p>Create <code class="highlighter-rouge">/etc/apache2/sites-available/wallabag.jasonthai.me.conf</code> and add the following:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;VirtualHost <span class="k">*</span>:80&gt;
    ServerName wallabag.jasonthai.me
    Redirect permanent / https://wallabag.jasonthai.me/
&lt;/VirtualHost&gt;

&lt;VirtualHost <span class="k">*</span>:443&gt;
    ServerAdmin webmaster@localhost
    ServerName wallabag.jasonthai.me
    ServerAlias wallabag.jasonthai.me

    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:8080/
    ProxyPassReverse / http://127.0.0.1:8080/

    ErrorLog <span class="k">${</span><span class="nv">APACHE_LOG_DIR</span><span class="k">}</span>/wallabag-error.log
    CustomLog <span class="k">${</span><span class="nv">APACHE_LOG_DIR</span><span class="k">}</span>/wallabag-access.log combined
SSLEngine on
SSLCertificateFile /etc/letsencrypt/live/jasonthai.me/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/jasonthai.me/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf
&lt;/VirtualHost&gt;
</code></pre></div></div><p>Note: I have already configured SSL/TLS certificates. You need to configure one yourself.</p><p>Enable the configuration and reload apache2:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>a2ensite /etc/apache2/sites-available/wallabag.jasonthai.me.conf
<span class="nv">$ </span><span class="nb">sudo </span>systemctl reload apache2
</code></pre></div></div><h1 id="configure-the-second-and-third-webserver-node"> <a class="anchor" href="#configure-the-second-and-third-webserver-node" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configure the second and third webserver node</h1><p>Do the same as the first node</p><h1 id="configure-haproxy-to-load-balance-three-webservers"> <a class="anchor" href="#configure-haproxy-to-load-balance-three-webservers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configure HAProxy to load balance three webservers</h1><p>ON your separate HAProxy node, Edit <code class="highlighter-rouge">/etc/haproxy/haproxy.cfg</code> and add the following (remember to replace with your actual domain):</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frontend https-in
    <span class="c"># Only bind on 80 if you also want to listen for connections on 80</span>
    <span class="nb">bind</span> <span class="k">*</span>:443 ssl crt /etc/certs/jasonthai.me.pem
    <span class="nb">bind</span> :::443 ssl crt /etc/certs/jasonthai.me.pem
    option httplog
    mode http
		
    acl wallabag hdr<span class="o">(</span>host<span class="o">)</span> <span class="nt">-i</span> wallabag.jasonthai.me
    use_backend wallabag <span class="k">if </span>wallabag

    default_backend no-match
		
backend wallabag
    mode http
    balance roundrobin
    option ssl-hello-chk
    option httpchk HEAD /login HTTP/1.1<span class="se">\r\n</span>Host:wallabag.jasonthai.me
    http-check expect status 200

    http-request disable-l7-retry <span class="k">if </span>METH_POST

    default-server ssl sni req.hdr<span class="o">(</span>Host<span class="o">)</span> check check-ssl verify none
    <span class="c"># Add an entry for each of your backend servers and their resolvable hostnames</span>
    server webserver-01 IP-of-webserver-01:443
    server webserver-02 IP-of-webserver-02:443
    server webserver-03 IP-of-webserver-03:443
</code></pre></div></div><p>Note: I have already configured SSL/TLS certificates. You need to configure one yourself.</p><h1 id="configure-dns-for-your-wallabag-and-ip"> <a class="anchor" href="#configure-dns-for-your-wallabag-and-ip" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configure DNS for your Wallabag and IP</h1><p>Depending on your DNS provider, you will need to configure this yourself. Point your Wallabag domain you configured to the IP address of HAProxy node we have just configured. You may also add another HAProxy node and use a GEO-based DNS to improve the performance and add some more redundancy.</p><h1 id="conclusion"> <a class="anchor" href="#conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion</h1><p>This post provides an example of setting up a highly available Wallabag using the technology we have convered so far in the high availability series. Future post will go into details of some failover mechanisms and good practices for HA systems.</p><h1 id="references"> <a class="anchor" href="#references" aria-hidden="true"><span class="octicon octicon-link"></span></a>References</h1><p><a href="https://jasonthai.me/blog/2020/06/08/high-availability-series-part-i-set-up-and-secure-mariadb-on-debian-servers/">[High Availability Series] PART I: Set Up and Use SSL to Secure MariaDB on Debian Servers</a></p><p><a href="https://jasonthai.me/blog/2020/06/20/high-availability-series-part-ii-configure-and-secure-a-3-node-galera-cluster/">[High Availability Series] PART II: Configure and Secure a 3-node Galera Cluster</a></p><p><a href="https://jasonthai.me/blog/2020/07/03/high-availability-series-part-iii-high-availability-galera-cluster-with-haproxy-and-stunnel/">[High Availability Series] PART III: High Availability Galera Cluster with HAProxy and Stunnel</a></p><p><a href="https://galeracluster.com/library/documentation/deployment-variants.html">https://galeracluster.com/library/documentation/deployment-variants.html</a></p></div><div class="flex items-center justify-center pa4"> <a href="/blog/2020/07/03/high-availability-series-part-iii-high-availability-galera-cluster-with-haproxy-and-stunnel/" class="f5 no-underline black bg-animate hover-bg-black hover-white inline-flex items-center pa3 ba border-box mr4"> <svg class="w1" data-icon="chevronLeft" viewBox="0 0 32 32" style="fill:currentcolor"><title>chevronLeft icon</title><path d="M20 1 L24 5 L14 16 L24 27 L20 31 L6 16 z"></path> </svg> <span class="pl1">Previous</span> </a></div><div id="commento"></div><script src="https://commento.jasonthai.me/js/commento.js"></script></div></article></div></main><footer class="avenir mid-gray flex-shrink-0"><div class="db w-100 h-auto fl mt3 pv4 bt b--light-silver"> <small class="f6 db tc"><b class="ttu">Jason&#39;s Notes</b> © 2019 - 2020</small></div></footer></body></html>
