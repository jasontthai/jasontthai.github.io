<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 --><title>Enable Offline Support to Websites with Workbox | Jason’s Notes</title><meta name="generator" content="Jekyll v3.8.7" /><meta property="og:title" content="Enable Offline Support to Websites with Workbox" /><meta name="author" content="Jason Thai" /><meta property="og:locale" content="en_US" /><meta name="description" content="A note of what Workbox is and how to use it to enable offline access for websites" /><meta property="og:description" content="A note of what Workbox is and how to use it to enable offline access for websites" /><link rel="canonical" href="https://jasonthai.me/blog/2019/08/06/enable-offline-support-to-websites-with-workbox/" /><meta property="og:url" content="https://jasonthai.me/blog/2019/08/06/enable-offline-support-to-websites-with-workbox/" /><meta property="og:site_name" content="Jason’s Notes" /><meta property="og:image" content="https://jasonthai.me/assets/img/workbox.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-08-06T00:00:00+00:00" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"https://jasonthai.me/blog/2019/08/06/enable-offline-support-to-websites-with-workbox/","headline":"Enable Offline Support to Websites with Workbox","dateModified":"2019-08-06T00:00:00+00:00","datePublished":"2019-08-06T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jasonthai.me/blog/2019/08/06/enable-offline-support-to-websites-with-workbox/"},"image":"https://jasonthai.me/assets/img/workbox.png","author":{"@type":"Person","name":"Jason Thai"},"description":"A note of what Workbox is and how to use it to enable offline access for websites","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --><link rel="stylesheet" href="https://cdn.jasonthai.me/assets/css/style.css"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" href="https://cdn.jasonthai.me/assets/img/apple-touch-icon.png"><meta name="theme-color" content="#fff" /><link type="application/atom+xml" rel="alternate" href="https://jasonthai.me/feed.xml" title="Jason's Notes" /><!-- <script src="/assets/js/lazysizes.min.js" async=""></script> --> <!-- <script src="/assets/js/ls.unveilhooks.min.js" async=""></script> --> <script type="text/javascript"> /*! lazysizes - v5.1.0 */ !function(a,b){var c=b(a,a.document);a.lazySizes=c,"object"==typeof module&&module.exports&&(module.exports=c)}("undefined"!=typeof window?window:{},function(a,b){"use strict";var c,d;if(function(){var b,c={lazyClass:"lazyload",loadedClass:"lazyloaded",loadingClass:"lazyloading",preloadClass:"lazypreload",errorClass:"lazyerror",autosizesClass:"lazyautosizes",srcAttr:"data-src",srcsetAttr:"data-srcset",sizesAttr:"data-sizes",minSize:40,customMedia:{},init:!0,expFactor:1.5,hFac:.8,loadMode:2,loadHidden:!0,ricTimeout:0,throttleDelay:125};d=a.lazySizesConfig||a.lazysizesConfig||{};for(b in c)b in d||(d[b]=c[b])}(),!b||!b.getElementsByClassName)return{init:function(){},cfg:d,noSupport:!0};var e=b.documentElement,f=a.Date,g=a.HTMLPictureElement,h="addEventListener",i="getAttribute",j=a[h],k=a.setTimeout,l=a.requestAnimationFrame||k,m=a.requestIdleCallback,n=/^picture$/i,o=["load","error","lazyincluded","_lazyloaded"],p={},q=Array.prototype.forEach,r=function(a,b){return p[b]||(p[b]=new RegExp("(\\s|^)"+b+"(\\s|$)")),p[b].test(a[i]("class")||"")&&p[b]},s=function(a,b){r(a,b)||a.setAttribute("class",(a[i]("class")||"").trim()+" "+b)},t=function(a,b){var c;(c=r(a,b))&&a.setAttribute("class",(a[i]("class")||"").replace(c," "))},u=function(a,b,c){var d=c?h:"removeEventListener";c&&u(a,b),o.forEach(function(c){a[d](c,b)})},v=function(a,d,e,f,g){var h=b.createEvent("Event");return e||(e={}),e.instance=c,h.initEvent(d,!f,!g),h.detail=e,a.dispatchEvent(h),h},w=function(b,c){var e;!g&&(e=a.picturefill||d.pf)?(c&&c.src&&!b[i]("srcset")&&b.setAttribute("srcset",c.src),e({reevaluate:!0,elements:[b]})):c&&c.src&&(b.src=c.src)},x=function(a,b){return(getComputedStyle(a,null)||{})[b]},y=function(a,b,c){for(c=c||a.offsetWidth;c<d.minSize&&b&&!a._lazysizesWidth;)c=b.offsetWidth,b=b.parentNode;return c},z=function(){var a,c,d=[],e=[],f=d,g=function(){var b=f;for(f=d.length?e:d,a=!0,c=!1;b.length;)b.shift()();a=!1},h=function(d,e){a&&!e?d.apply(this,arguments):(f.push(d),c||(c=!0,(b.hidden?k:l)(g)))};return h._lsFlush=g,h}(),A=function(a,b){return b?function(){z(a)}:function(){var b=this,c=arguments;z(function(){a.apply(b,c)})}},B=function(a){var b,c=0,e=d.throttleDelay,g=d.ricTimeout,h=function(){b=!1,c=f.now(),a()},i=m&&g>49?function(){m(h,{timeout:g}),g!==d.ricTimeout&&(g=d.ricTimeout)}:A(function(){k(h)},!0);return function(a){var d;(a=!0===a)&&(g=33),b||(b=!0,d=e-(f.now()-c),d<0&&(d=0),a||d<9?i():k(i,d))}},C=function(a){var b,c,d=99,e=function(){b=null,a()},g=function(){var a=f.now()-c;a<d?k(g,d-a):(m||e)(e)};return function(){c=f.now(),b||(b=k(g,d))}},D=function(){var g,l,m,o,p,y,D,F,G,H,I,J,K=/^img$/i,L=/^iframe$/i,M="onscroll"in a&&!/(gle|ing)bot/.test(navigator.userAgent),N=0,O=0,P=0,Q=-1,R=function(a){P--,(!a||P<0||!a.target)&&(P=0)},S=function(a){return null==J&&(J="hidden"==x(b.body,"visibility")),J||"hidden"!=x(a.parentNode,"visibility")&&"hidden"!=x(a,"visibility")},T=function(a,c){var d,f=a,g=S(a);for(F-=c,I+=c,G-=c,H+=c;g&&(f=f.offsetParent)&&f!=b.body&&f!=e;)(g=(x(f,"opacity")||1)>0)&&"visible"!=x(f,"overflow")&&(d=f.getBoundingClientRect(),g=H>d.left&&G<d.right&&I>d.top-1&&F<d.bottom+1);return g},U=function(){var a,f,h,j,k,m,n,p,q,r,s,t,u=c.elements;if((o=d.loadMode)&&P<8&&(a=u.length)){for(f=0,Q++;f<a;f++)if(u[f]&&!u[f]._lazyRace)if(!M||c.prematureUnveil&&c.prematureUnveil(u[f]))aa(u[f]);else if((p=u[f][i]("data-expand"))&&(m=1*p)||(m=O),r||(r=!d.expand||d.expand<1?e.clientHeight>500&&e.clientWidth>500?500:370:d.expand,c._defEx=r,s=r*d.expFactor,t=d.hFac,J=null,O<s&&P<1&&Q>2&&o>2&&!b.hidden?(O=s,Q=0):O=o>1&&Q>1&&P<6?r:N),q!==m&&(y=innerWidth+m*t,D=innerHeight+m,n=-1*m,q=m),h=u[f].getBoundingClientRect(),(I=h.bottom)>=n&&(F=h.top)<=D&&(H=h.right)>=n*t&&(G=h.left)<=y&&(I||H||G||F)&&(d.loadHidden||S(u[f]))&&(l&&P<3&&!p&&(o<3||Q<4)||T(u[f],m))){if(aa(u[f]),k=!0,P>9)break}else!k&&l&&!j&&P<4&&Q<4&&o>2&&(g[0]||d.preloadAfterLoad)&&(g[0]||!p&&(I||H||G||F||"auto"!=u[f][i](d.sizesAttr)))&&(j=g[0]||u[f]);j&&!k&&aa(j)}},V=B(U),W=function(a){var b=a.target;if(b._lazyCache)return void delete b._lazyCache;R(a),s(b,d.loadedClass),t(b,d.loadingClass),u(b,Y),v(b,"lazyloaded")},X=A(W),Y=function(a){X({target:a.target})},Z=function(a,b){try{a.contentWindow.location.replace(b)}catch(c){a.src=b}},$=function(a){var b,c=a[i](d.srcsetAttr);(b=d.customMedia[a[i]("data-media")||a[i]("media")])&&a.setAttribute("media",b),c&&a.setAttribute("srcset",c)},_=A(function(a,b,c,e,f){var g,h,j,l,o,p;(o=v(a,"lazybeforeunveil",b)).defaultPrevented||(e&&(c?s(a,d.autosizesClass):a.setAttribute("sizes",e)),h=a[i](d.srcsetAttr),g=a[i](d.srcAttr),f&&(j=a.parentNode,l=j&&n.test(j.nodeName||"")),p=b.firesLoad||"src"in a&&(h||g||l),o={target:a},s(a,d.loadingClass),p&&(clearTimeout(m),m=k(R,2500),u(a,Y,!0)),l&&q.call(j.getElementsByTagName("source"),$),h?a.setAttribute("srcset",h):g&&!l&&(L.test(a.nodeName)?Z(a,g):a.src=g),f&&(h||l)&&w(a,{src:g})),a._lazyRace&&delete a._lazyRace,t(a,d.lazyClass),z(function(){var b=a.complete&&a.naturalWidth>1;p&&!b||(b&&s(a,"ls-is-cached"),W(o),a._lazyCache=!0,k(function(){"_lazyCache"in a&&delete a._lazyCache},9)),"lazy"==a.loading&&P--},!0)}),aa=function(a){if(!a._lazyRace){var b,c=K.test(a.nodeName),e=c&&(a[i](d.sizesAttr)||a[i]("sizes")),f="auto"==e;(!f&&l||!c||!a[i]("src")&&!a.srcset||a.complete||r(a,d.errorClass)||!r(a,d.lazyClass))&&(b=v(a,"lazyunveilread").detail,f&&E.updateElem(a,!0,a.offsetWidth),a._lazyRace=!0,P++,_(a,b,f,e,c))}},ba=C(function(){d.loadMode=3,V()}),ca=function(){3==d.loadMode&&(d.loadMode=2),ba()},da=function(){if(!l){if(f.now()-p<999)return void k(da,999);l=!0,d.loadMode=3,V(),j("scroll",ca,!0)}};return{_:function(){p=f.now(),c.elements=b.getElementsByClassName(d.lazyClass),g=b.getElementsByClassName(d.lazyClass+" "+d.preloadClass),j("scroll",V,!0),j("resize",V,!0),a.MutationObserver?new MutationObserver(V).observe(e,{childList:!0,subtree:!0,attributes:!0}):(e[h]("DOMNodeInserted",V,!0),e[h]("DOMAttrModified",V,!0),setInterval(V,999)),j("hashchange",V,!0),["focus","mouseover","click","load","transitionend","animationend"].forEach(function(a){b[h](a,V,!0)}),/d$|^c/.test(b.readyState)?da():(j("load",da),b[h]("DOMContentLoaded",V),k(da,2e4)),c.elements.length?(U(),z._lsFlush()):V()},checkElems:V,unveil:aa,_aLSL:ca}}(),E=function(){var a,c=A(function(a,b,c,d){var e,f,g;if(a._lazysizesWidth=d,d+="px",a.setAttribute("sizes",d),n.test(b.nodeName||""))for(e=b.getElementsByTagName("source"),f=0,g=e.length;f<g;f++)e[f].setAttribute("sizes",d);c.detail.dataAttr||w(a,c.detail)}),e=function(a,b,d){var e,f=a.parentNode;f&&(d=y(a,f,d),e=v(a,"lazybeforesizes",{width:d,dataAttr:!!b}),e.defaultPrevented||(d=e.detail.width)&&d!==a._lazysizesWidth&&c(a,f,e,d))},f=function(){var b,c=a.length;if(c)for(b=0;b<c;b++)e(a[b])},g=C(f);return{_:function(){a=b.getElementsByClassName(d.autosizesClass),j("resize",g)},checkElems:g,updateElem:e}}(),F=function(){!F.i&&b.getElementsByClassName&&(F.i=!0,E._(),D._())};return k(function(){d.init&&F()}),c={cfg:d,autoSizer:E,loader:D,init:F,uP:w,aC:s,rC:t,hC:r,fire:v,gW:y,rAF:z}}); /*! lazysizes - v5.1.0 */ !function(a,b){var c=function(){b(a.lazySizes),a.removeEventListener("lazyunveilread",c,!0)};b=b.bind(null,a,a.document),"object"==typeof module&&module.exports?b(require("lazysizes")):a.lazySizes?c():a.addEventListener("lazyunveilread",c,!0)}(window,function(a,b,c){"use strict";function d(a,c){if(!g[a]){var d=b.createElement(c?"link":"script"),e=b.getElementsByTagName("script")[0];c?(d.rel="stylesheet",d.href=a):d.src=a,g[a]=!0,g[d.src||d.href]=!0,e.parentNode.insertBefore(d,e)}}var e,f,g={};b.addEventListener&&(f=/\(|\)|\s|'/,e=function(a,c){var d=b.createElement("img");d.onload=function(){d.onload=null,d.onerror=null,d=null,c()},d.onerror=d.onload,d.src=a,d&&d.complete&&d.onload&&d.onload()},addEventListener("lazybeforeunveil",function(a){if(a.detail.instance==c){var b,g,h,i;a.defaultPrevented||("none"==a.target.preload&&(a.target.preload="auto"),b=a.target.getAttribute("data-link"),b&&d(b,!0),b=a.target.getAttribute("data-script"),b&&d(b),b=a.target.getAttribute("data-require"),b&&(c.cfg.requireJs?c.cfg.requireJs([b]):d(b)),h=a.target.getAttribute("data-bg"),h&&(a.detail.firesLoad=!0,g=function(){a.target.style.backgroundImage="url("+(f.test(h)?JSON.stringify(h):h)+")",a.detail.firesLoad=!1,c.fire(a.target,"_lazyloaded",{},!0,!0)},e(h,g)),(i=a.target.getAttribute("data-poster"))&&(a.detail.firesLoad=!0,g=function(){a.target.poster=i,a.detail.firesLoad=!1,c.fire(a.target,"_lazyloaded",{},!0,!0)},e(i,g)))}},!1))}); </script> <script> /* Check that service workers are supported */ if ('serviceWorker' in navigator) { /* Use the window load event to keep the page load performant */ window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js'); }); } </script> <!-- Matomo --> <script type="text/javascript"> var _paq = window._paq || []; /* tracker methods like "setCustomDimension" should be called before "trackPageView" */ _paq.push(["setDocumentTitle", document.domain + "/" + document.title]); _paq.push(['trackPageView']); _paq.push(['enableLinkTracking']); _paq.push(['enableHeartBeatTimer']); (function() { var u="//analytics.jasonthai.me/"; _paq.push(['setTrackerUrl', u+'matomo.php']); _paq.push(['setSiteId', '1']); var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s); })(); </script> <noscript><p><img src="//analytics.jasonthai.me/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt="" /></p></noscript> <!-- End Matomo Code --></head><body class="flex flex-column vh-100"><header class="avenir"><nav class="db bb b--light-silver dt-l w-100 border-box pa3 ph5-l"> <a class="db dtc-l v-mid mid-gray link underline-hover w-100 w-25-l tc tl-l mb2 mb0-l f3-l" href="/" title="Home"> <img src="/favicon.png" class="v-mid w2 h2 br-100" alt="Site Name"> Jason's Notes </a><div class="db dtc-l v-mid w-100 w-75-l tc tr-l"><a class="link underline-hover dark-gray f6 f5-l dib mr3 mr4-l" href="/about/">About</a><a class="link underline-hover dark-gray f6 f5-l dib mr3 mr4-l" href="/services/">Services</a><a class="link underline-hover dark-gray f6 f5-l dib mr3 mr4-l" href="/posts/">Posts</a><a class="link underline-hover dark-gray f6 f5-l dib mr3 mr4-l" href="/categories/">Categories</a><a class="link underline-hover dark-gray f6 f5-l dib mr3 mr4-l" href="/visited-places/">Places I Visited</a></div></nav></header><main class="db h-auto w-100 ph5-l flex-grow-1" aria-label="Content"><div class="db fl-l w-100"><article class="avenir center w-two-thirds-ns w-90"><header class="pt2 pt3-ns"><h1 class="tc f1-l lh-title mt0 baskerville">Enable Offline Support to Websites with Workbox</h1><time class="tc f5 f4-l db">Aug 6, 2019 </time><p class="tc f5 mb4 center lh-copy"> Jason Thai</p></header><div class=""><div class="db f5 lh-copy"><ul class="section-nav"><li class="toc-entry toc-h2"><a href="#tldr">TLDR</a></li><li class="toc-entry toc-h2"><a href="#what-is-workbox">What is Workbox?</a></li><li class="toc-entry toc-h2"><a href="#enable-service-worker">Enable service worker</a></li><li class="toc-entry toc-h2"><a href="#using-workbox">Using Workbox</a><ul><li class="toc-entry toc-h3"><a href="#install-workbox-cli">Install workbox-cli</a></li><li class="toc-entry toc-h3"><a href="#setup-service-worker">Setup service worker</a></li><li class="toc-entry toc-h3"><a href="#use-workbox-cli-to-populate-what-to-precache">Use workbox-cli to populate what to precache</a></li><li class="toc-entry toc-h3"><a href="#manually-specify-what-to-cache-during-runtime">Manually specify what to cache during runtime</a></li></ul></li><li class="toc-entry toc-h2"><a href="#add-to-build-and-automate">Add to build and automate</a></li><li class="toc-entry toc-h2"><a href="#considerations">Considerations</a></li></ul><picture> <source srcset="https://cdn.jasonthai.me/assets/img/workbox.webp" type="image/webp"></source> <img class="db ml-auto mr-auto" src="https://cdn.jasonthai.me/https://jasonthai.me/assets/img/workbox.png" alt="workbox"> </picture><p>Recently I have added offline support for this blog using <a href="https://developers.google.com/web/tools/workbox/">Workbox</a>. You can test this by going offline and then browsing my blog. This note gives a walkthrough of how I did it and summarizes my findings. <!--more--></p><h2 id="tldr"> <a class="anchor" href="#tldr" aria-hidden="true"><span class="octicon octicon-link"></span></a>TLDR</h2><p>Steps to enable offline support:</p><ul><li>Enable service worker</li><li>Create sw.js with<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">importScripts</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://storage.googleapis.com/workbox-cdn/releases/4.3.1/workbox-sw.js</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">workbox</span><span class="p">.</span><span class="nx">precaching</span><span class="p">.</span><span class="nx">precacheAndRoute</span><span class="p">([]);</span>
</code></pre></div></div></li><li>Install workbox-cli with <code class="highlighter-rouge">npm install workbox-cli --global</code></li><li>Follow workbox wizard <code class="highlighter-rouge">workbox wizard --injectManifest</code></li><li>Inject <code class="highlighter-rouge">sw.js</code> with what to cache <code class="highlighter-rouge">workbox injectManifest workbox-config.js</code></li></ul><h2 id="what-is-workbox"> <a class="anchor" href="#what-is-workbox" aria-hidden="true"><span class="octicon octicon-link"></span></a>What is Workbox?</h2><p>Workbox is a set of javascript libraries that add support for caching and offline access of web apps. Workbox provides an abstract layer for developers when working with <a href="https://developers.google.com/web/fundamentals/primers/service-workers/">service workers</a>. Some of the things workbox support like precaching, runtime caching, etc will be covered below.</p><p>Does your browser support workbox and service workers? <a href="https://love2dev.com/blog/what-browsers-support-service-workers/">Check here</a></p><h2 id="enable-service-worker"> <a class="anchor" href="#enable-service-worker" aria-hidden="true"><span class="octicon octicon-link"></span></a>Enable service worker</h2><p>Add this script to the bottom of your website:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
<span class="c1">// Check that service workers are supported</span>
<span class="k">if</span> <span class="p">(</span><span class="dl">'</span><span class="s1">serviceWorker</span><span class="dl">'</span> <span class="k">in</span> <span class="nb">navigator</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Use the window load event to keep the page load performant</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">load</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nb">navigator</span><span class="p">.</span><span class="nx">serviceWorker</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="dl">'</span><span class="s1">/sw.js</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div><p>This tells the browser to wait until the window load and then register for service worker in <code class="highlighter-rouge">/sw.js</code> route.</p><h2 id="using-workbox"> <a class="anchor" href="#using-workbox" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using Workbox</h2><p>There are a few ways to generate service workers using Workbox. I choose to use workbox-cli as I can enable it as part of my build pipeline for my blog which is currently powered by Jekyll. If you use Node or Gulp, you can use <a href="https://developers.google.com/web/tools/workbox/guides/precache-files/workbox-build">workbox-build</a> or if you use Webpack, there is <a href="https://developers.google.com/web/tools/workbox/guides/precache-files/webpack">workbox-webpack-plugin</a>.</p><h3 id="install-workbox-cli"> <a class="anchor" href="#install-workbox-cli" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install workbox-cli</h3><p>Install by using npm:</p><p><code class="highlighter-rouge">npm install workbox-cli --global</code></p><h3 id="setup-service-worker"> <a class="anchor" href="#setup-service-worker" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup service worker</h3><p>In <code class="highlighter-rouge">sw.js</code> specify the following boilerplate code:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">importScripts</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://storage.googleapis.com/workbox-cdn/releases/4.3.1/workbox-sw.js</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">workbox</span><span class="p">.</span><span class="nx">precaching</span><span class="p">.</span><span class="nx">precacheAndRoute</span><span class="p">([])</span> 
</code></pre></div></div><p>Notice we have not specified anything yet to precache. This serves as an injection point for workbox to compute and inject all the routes to be cached.</p><h3 id="use-workbox-cli-to-populate-what-to-precache"> <a class="anchor" href="#use-workbox-cli-to-populate-what-to-precache" aria-hidden="true"><span class="octicon octicon-link"></span></a>Use workbox-cli to populate what to precache</h3><p>Run workbox-cli wizard</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">workbox</span> <span class="nx">wizard</span> <span class="o">--</span><span class="nx">injectManifest</span>
</code></pre></div></div><p>This command provides the option to specify what to cache by looking at all the file extensions in the website. After this is done, a new file called <code class="highlighter-rouge">workbox-config.js</code> will be created.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">workbox</span> <span class="nx">injectManifest</span> <span class="nx">workbox</span><span class="o">-</span><span class="nx">config</span><span class="p">.</span><span class="nx">js</span>
</code></pre></div></div><p>This command then uses what is specified in <code class="highlighter-rouge">workbox-config.js</code> and injects all the files to be cached into the injection point we specified above in <code class="highlighter-rouge">sw.js</code> files.</p><h3 id="manually-specify-what-to-cache-during-runtime"> <a class="anchor" href="#manually-specify-what-to-cache-during-runtime" aria-hidden="true"><span class="octicon octicon-link"></span></a>Manually specify what to cache during runtime</h3><p>There are already a few <a href="https://developers.google.com/web/tools/workbox/guides/common-recipes">common recipes</a> that provide examples of caching css, js, images, etc.</p><p><a href="https://jasonthai.me/sw.js">I use a few from those recipes for my site</a>:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Caching Images</span>
<span class="nx">workbox</span><span class="p">.</span><span class="nx">routing</span><span class="p">.</span><span class="nx">registerRoute</span><span class="p">(</span>
  <span class="sr">/</span><span class="se">\.(?:</span><span class="sr">png|gif|jpg|jpeg|webp|svg</span><span class="se">)</span><span class="sr">$/</span><span class="p">,</span>
  <span class="k">new</span> <span class="nx">workbox</span><span class="p">.</span><span class="nx">strategies</span><span class="p">.</span><span class="nx">CacheFirst</span><span class="p">({</span>
    <span class="na">cacheName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">images</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">plugins</span><span class="p">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">workbox</span><span class="p">.</span><span class="nx">expiration</span><span class="p">.</span><span class="nx">Plugin</span><span class="p">({</span>
        <span class="na">maxEntries</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
        <span class="na">maxAgeSeconds</span><span class="p">:</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="c1">// 30 Days</span>
      <span class="p">}),</span>
    <span class="p">],</span>
  <span class="p">})</span>
<span class="p">);</span>

<span class="c1">// Cache CSS and JavaScript Files</span>
<span class="nx">workbox</span><span class="p">.</span><span class="nx">routing</span><span class="p">.</span><span class="nx">registerRoute</span><span class="p">(</span>
  <span class="sr">/</span><span class="se">\.(?:</span><span class="sr">js|css</span><span class="se">)</span><span class="sr">$/</span><span class="p">,</span>
  <span class="k">new</span> <span class="nx">workbox</span><span class="p">.</span><span class="nx">strategies</span><span class="p">.</span><span class="nx">StaleWhileRevalidate</span><span class="p">({</span>
    <span class="na">cacheName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">static-resources</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">})</span>
<span class="p">);</span>

<span class="c1">// Caching Content from Multiple Origins</span>
<span class="nx">workbox</span><span class="p">.</span><span class="nx">routing</span><span class="p">.</span><span class="nx">registerRoute</span><span class="p">(</span>
  <span class="sr">/.*</span><span class="se">(?:</span><span class="sr">googleapis|gstatic</span><span class="se">)\.</span><span class="sr">com/</span><span class="p">,</span>
  <span class="k">new</span> <span class="nx">workbox</span><span class="p">.</span><span class="nx">strategies</span><span class="p">.</span><span class="nx">StaleWhileRevalidate</span><span class="p">(),</span>
<span class="p">);</span>
</code></pre></div></div><h2 id="add-to-build-and-automate"> <a class="anchor" href="#add-to-build-and-automate" aria-hidden="true"><span class="octicon octicon-link"></span></a>Add to build and automate</h2><p><a href="https://jasonthai.me/blog/2019/07/22/how-to-deploy-a-github-page-using-circleci-20-custom-jekyll-gems/">Since I am using CircleCI to deploy changes of my site to Github Pages</a>, I also add the workbox + service worker script generation to the build.</p><p>Declared <code class="highlighter-rouge">workbox-config.js</code>:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="dl">"</span><span class="s2">globDirectory</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">_site/</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">globPatterns</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
    <span class="dl">"</span><span class="s2">**/*.{html,txt,css,webp,js,json,svg,ico}</span><span class="dl">"</span>
  <span class="p">],</span>
  <span class="dl">"</span><span class="s2">swDest</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">_site/sw.js</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">swSrc</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">sw.js</span><span class="dl">"</span>
<span class="p">};</span>
</code></pre></div></div><p>In <code class="highlighter-rouge">config.yml</code> file I added:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="c1"># -- more omitted --</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">JEKYLL_ENV=production bundle exec jekyll build</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">npm install workbox-cli</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">npx workbox injectManifest workbox-config.js</span>
      <span class="c1"># -- more omitted --</span>
</code></pre></div></div><p>It is quite simple, just added two extra steps to install workbox-cli and run the same command to inject the precache routes.</p><h2 id="considerations"> <a class="anchor" href="#considerations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Considerations</h2><ul><li>Using the workbox-cli, we can cache everything on the site. However, this will not work if the website contains thousands of posts and images as everything will be downloaded to the browser cache.</li><li>Using the workbox-cli, we can only set service workers to cache our website’s assets. It will not handle caching other website’s sites. This is important because we probably use things like external fonts, javascripts, css files, etc. So we need to manually add that support to our service workers.</li></ul></div><div class="flex items-center justify-center pa4"> <a href="/blog/2019/08/04/three-proofs-total-stock-market-is-efficient/" class="f5 no-underline black bg-animate hover-bg-black hover-white inline-flex items-center pa3 ba border-box mr4"> <svg class="w1" data-icon="chevronLeft" viewBox="0 0 32 32" style="fill:currentcolor"><title>chevronLeft icon</title><path d="M20 1 L24 5 L14 16 L24 27 L20 31 L6 16 z"></path> </svg> <span class="pl1">Previous</span> </a> <a href="/blog/2019/08/07/i-turned-my-blog-into-a-web-progress-app/" class="f5 no-underline black bg-animate hover-bg-black hover-white inline-flex items-center pa3 ba border-box"> <span class="pr1">Next</span> <svg class="w1" data-icon="chevronRight" viewBox="0 0 32 32" style="fill:currentcolor"><title>chevronRight icon</title><path d="M12 1 L26 16 L12 31 L8 27 L18 16 L8 5 z"></path> </svg> </a></div><div id="commento"></div><script src="https://commento.jasonthai.me/js/commento.js"></script></div></article></div></main><footer class="avenir mid-gray flex-shrink-0"><div class="db w-100 h-auto fl mt3 pv4 bt b--light-silver"> <small class="f6 db tc"><b class="ttu">Jason&#39;s Notes</b> © 2019 - 2020</small></div></footer></body></html>
