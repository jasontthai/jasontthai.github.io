<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.8.7">Jekyll</generator><link href="https://jasonthai.me/feed.xml" rel="self" type="application/atom+xml" /><link href="https://jasonthai.me/" rel="alternate" type="text/html" /><updated>2020-06-21T02:17:42+00:00</updated><id>https://jasonthai.me/feed.xml</id><title type="html">Jason’s Notes</title><subtitle>Jason Thai's personal page</subtitle><author><name>Jason Thai</name></author><entry><title type="html">[High Availability Series] PART II: Configure and Secure a 3-node Galera Cluster</title><link href="https://jasonthai.me/blog/2020/06/20/high-availability-series-part-ii-configure-and-secure-a-3-node-galera-cluster/" rel="alternate" type="text/html" title="[High Availability Series] PART II: Configure and Secure a 3-node Galera Cluster" /><published>2020-06-20T00:00:00+00:00</published><updated>2020-06-20T00:00:00+00:00</updated><id>https://jasonthai.me/blog/2020/06/20/high-availability-series-part-ii-configure-and-secure-a-3-node-galera-cluster</id><content type="html" xml:base="https://jasonthai.me/blog/2020/06/20/high-availability-series-part-ii-configure-and-secure-a-3-node-galera-cluster/">&lt;h1 id=&quot;introduction&quot;&gt;Introduction&lt;/h1&gt;
&lt;p&gt;Second part of the series covers how to set up and secure a multi master Galera cluster consisting of 3 mariadb servers. A multi master cluster allow reads and writes from any of the nodes. Changes are replicated synchronously to the other nodes.&lt;/p&gt;

&lt;p&gt;We will go over how to set it up and secure the communication between the three nodes. There are 3 different vectors that we can secure through SSL: traffic between the database server and client, replication traffic within Galera Cluster, and the State Snapshot Transfer (SST). We will go over all three.&lt;/p&gt;

&lt;h1 id=&quot;initial-configuration&quot;&gt;Initial Configuration:&lt;/h1&gt;
&lt;p&gt;On every node of the cluster, add the following lines in &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/hosts&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;IP-of-node1 galera-01
IP-of-node2 galera-02
IP-of-node3 galera-03
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Optional: Setting up the firewall to only allow cluster traffic communication between the three nodes with ufw. 
Galera requires a number of ports for connectivity between its nodes. Below is the list:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;3306 is the default port for MySQL client connections and State Snapshot Transfer using mysqldump for backups.
4567 is reserved for Galera Cluster replication traffic. Multicast replication uses both TCP and UDP transport on this port.
4568 is the port for Incremental State Transfer.
4444 is used for all other State Snapshot Transfer.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Example of ufw configuration on node1:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;ufw allow from IP-of-node2 to any port 3306 proto tcp
&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;ufw allow from IP-of-node2 to any port 4444 proto tcp
&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;ufw allow from IP-of-node2 to any port 4567 proto tcp
&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;ufw allow from IP-of-node2 to any port 4568 proto tcp
&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;ufw allow from IP-of-node2 to any port 4567 proto udp

&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;ufw allow from IP-of-node3 to any port 3306 proto tcp
&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;ufw allow from IP-of-node3 to any port 4444 proto tcp
&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;ufw allow from IP-of-node3 to any port 4567 proto tcp
&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;ufw allow from IP-of-node3 to any port 4568 proto tcp
&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;ufw allow from IP-of-node3 to any port 4567 proto udp

&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;ufw reload
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h1 id=&quot;configure-the-first-node&quot;&gt;Configure the first node:&lt;/h1&gt;
&lt;p&gt;Following the the first part of the series, we have covered securing the traffic between the server and the client. Now we are ready to initialize the first node of the cluster.&lt;/p&gt;

&lt;p&gt;Create &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/mysql/mariadb.conf.d/galera.cnf&lt;/code&gt; and add the following lines:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;mysqld]
&lt;span class=&quot;nv&quot;&gt;binlog_format&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;ROW
default-storage-engine&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;innodb
&lt;span class=&quot;nv&quot;&gt;innodb_autoinc_lock_mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2
bind-address&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0.0.0.0

&lt;span class=&quot;c&quot;&gt;# Galera Provider Configuration&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_on&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;ON
&lt;span class=&quot;nv&quot;&gt;wsrep_provider&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/lib/galera/libgalera_smm.so
&lt;span class=&quot;c&quot;&gt;# Configuration to secure traffic replication&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_provider_options&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;socket.ssl_key=/etc/mysql/certs/server-key.pem;socket.ssl_cert=/etc/mysql/certs/server-cert.pem;socket.ssl_ca=/etc/mysql/certs/ca-cert.pem&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Galera Cluster Configuration&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_cluster_name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;galera_cluster&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_cluster_address&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;gcomm://galera-01,galera-02,galera-03&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Galera Synchronization Configuration&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_sst_auth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;xtra:replace-your-verify-secure-replication-password-here
&lt;span class=&quot;nv&quot;&gt;wsrep_sst_method&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;mariabackup

&lt;span class=&quot;c&quot;&gt;# Galera Node Configuration&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_node_address&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;galera-01
&lt;span class=&quot;nv&quot;&gt;wsrep_node_name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;galera-db-01

&lt;span class=&quot;c&quot;&gt;# Configuration to secure the SST connection&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;sst]
&lt;span class=&quot;nv&quot;&gt;encrypt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;3
&lt;span class=&quot;nv&quot;&gt;tcert&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/mysql/certs/server-cert.pem
&lt;span class=&quot;nv&quot;&gt;tkey&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/mysql/certs/server-key.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Inititialize Galera cluster:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl stop mariadb
&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;galera_new_cluster
&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl status mariadb 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;configure-the-second-node&quot;&gt;Configure the second node:&lt;/h1&gt;
&lt;p&gt;Following part I of the series, we have created all the necessary certs in node 1 of the cluster. We do not have to create the certs again, simply copy the certs from the first node to the second node and place them in &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/mysql/certs&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Create &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/mysql/mariadb.conf.d/galera.cnf&lt;/code&gt; and add the following lines:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;mysqld]
&lt;span class=&quot;nv&quot;&gt;binlog_format&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;ROW
default-storage-engine&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;innodb
&lt;span class=&quot;nv&quot;&gt;innodb_autoinc_lock_mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2
bind-address&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0.0.0.0

&lt;span class=&quot;c&quot;&gt;# Galera Provider Configuration&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_on&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;ON
&lt;span class=&quot;nv&quot;&gt;wsrep_provider&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/lib/galera/libgalera_smm.so
&lt;span class=&quot;c&quot;&gt;# Configuration to secure traffic replication&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_provider_options&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;socket.ssl_key=/etc/mysql/certs/server-key.pem;socket.ssl_cert=/etc/mysql/certs/server-cert.pem;socket.ssl_ca=/etc/mysql/certs/ca-cert.pem&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Galera Cluster Configuration&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_cluster_name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;galera_cluster&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_cluster_address&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;gcomm://galera-01,galera-02,galera-03&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Galera Synchronization Configuration&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_sst_auth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;xtra:replace-your-verify-secure-replication-password-here
&lt;span class=&quot;nv&quot;&gt;wsrep_sst_method&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;mariabackup

&lt;span class=&quot;c&quot;&gt;# Galera Node Configuration&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_node_address&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;galera-02
&lt;span class=&quot;nv&quot;&gt;wsrep_node_name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;galera-db-02

&lt;span class=&quot;c&quot;&gt;# Configuration to secure the SST connection&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;sst]
&lt;span class=&quot;nv&quot;&gt;encrypt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;3
&lt;span class=&quot;nv&quot;&gt;tcert&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/mysql/certs/server-cert.pem
&lt;span class=&quot;nv&quot;&gt;tkey&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/mysql/certs/server-key.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Restart Mariadb&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-02&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl restart mariadb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h1 id=&quot;configure-the-third-node&quot;&gt;Configure the third node:&lt;/h1&gt;
&lt;p&gt;Again copy the certs from the first node to the third node and place them in &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/mysql/certs&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Create &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/mysql/mariadb.conf.d/galera.cnf&lt;/code&gt; and add the following lines:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;mysqld]
&lt;span class=&quot;nv&quot;&gt;binlog_format&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;ROW
default-storage-engine&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;innodb
&lt;span class=&quot;nv&quot;&gt;innodb_autoinc_lock_mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2
bind-address&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0.0.0.0

&lt;span class=&quot;c&quot;&gt;# Galera Provider Configuration&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_on&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;ON
&lt;span class=&quot;nv&quot;&gt;wsrep_provider&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/lib/galera/libgalera_smm.so
&lt;span class=&quot;c&quot;&gt;# Configuration to secure traffic replication&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_provider_options&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;socket.ssl_key=/etc/mysql/certs/server-key.pem;socket.ssl_cert=/etc/mysql/certs/server-cert.pem;socket.ssl_ca=/etc/mysql/certs/ca-cert.pem&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Galera Cluster Configuration&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_cluster_name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;galera_cluster&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_cluster_address&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;gcomm://galera-01,galera-02,galera-03&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Galera Synchronization Configuration&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_sst_auth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;xtra:replace-your-verify-secure-replication-password-here
&lt;span class=&quot;nv&quot;&gt;wsrep_sst_method&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;mariabackup

&lt;span class=&quot;c&quot;&gt;# Galera Node Configuration&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;wsrep_node_address&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;galera-03
&lt;span class=&quot;nv&quot;&gt;wsrep_node_name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;galera-db-03

&lt;span class=&quot;c&quot;&gt;# Configuration to secure the SST connection&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;sst]
&lt;span class=&quot;nv&quot;&gt;encrypt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;3
&lt;span class=&quot;nv&quot;&gt;tcert&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/mysql/certs/server-cert.pem
&lt;span class=&quot;nv&quot;&gt;tkey&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/mysql/certs/server-key.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Restart Mariadb&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl restart mariadb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;verify-mariadb-galera-cluster-settings&quot;&gt;Verify MariaDB Galera Cluster Settings&lt;/h1&gt;
&lt;p&gt;Login to MySQL console from a node in the cluster as root user.&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Welcome to the MariaDB monitor.  Commands end with &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; or &lt;span class=&quot;se&quot;&gt;\g&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Your MariaDB connection &lt;span class=&quot;nb&quot;&gt;id &lt;/span&gt;is 122994
Server version: 10.4.13-MariaDB-1:10.4.13+maria~buster mariadb.org binary distribution

Copyright &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type &lt;span class=&quot;s1&quot;&gt;'help;'&lt;/span&gt; or &lt;span class=&quot;s1&quot;&gt;'\h'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;help. Type &lt;span class=&quot;s1&quot;&gt;'\c'&lt;/span&gt; to clear the current input statement.

MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Check the cluster size:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; SHOW STATUS LIKE &lt;span class=&quot;s1&quot;&gt;'wsrep_cluster_size'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
+--------------------+-------+
| Variable_name      | Value |
+--------------------+-------+
| wsrep_cluster_size | 3     |
+--------------------+-------+
1 row &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.001 sec&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To view all status related to cluster:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; SHOW GLOBAL STATUS LIKE &lt;span class=&quot;s1&quot;&gt;'wsrep_%'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h1 id=&quot;verify-cluster-replication&quot;&gt;Verify Cluster Replication&lt;/h1&gt;
&lt;p&gt;On node1:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;mysql
Welcome to the MariaDB monitor.  Commands end with &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; or &lt;span class=&quot;se&quot;&gt;\g&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Your MariaDB connection &lt;span class=&quot;nb&quot;&gt;id &lt;/span&gt;is 118912
Server version: 10.4.13-MariaDB-1:10.4.13+maria~buster mariadb.org binary distribution

Copyright &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type &lt;span class=&quot;s1&quot;&gt;'help;'&lt;/span&gt; or &lt;span class=&quot;s1&quot;&gt;'\h'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;help. Type &lt;span class=&quot;s1&quot;&gt;'\c'&lt;/span&gt; to clear the current input statement.

MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; create database test1&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
Query OK, 1 row affected &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.033 sec&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show databases&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| test1              |
+--------------------+
4 rows &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.410 sec&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On node 2 or 3:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;mysql
Welcome to the MariaDB monitor.  Commands end with &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; or &lt;span class=&quot;se&quot;&gt;\g&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Your MariaDB connection &lt;span class=&quot;nb&quot;&gt;id &lt;/span&gt;is 124058
Server version: 10.4.13-MariaDB-1:10.4.13+maria~buster mariadb.org binary distribution

Copyright &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type &lt;span class=&quot;s1&quot;&gt;'help;'&lt;/span&gt; or &lt;span class=&quot;s1&quot;&gt;'\h'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;help. Type &lt;span class=&quot;s1&quot;&gt;'\c'&lt;/span&gt; to clear the current input statement.

MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show databases&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| test1              |
+--------------------+
4 rows &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.954 sec&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h1 id=&quot;verify-secure-connection-between-nodes&quot;&gt;Verify Secure Connection Between Nodes&lt;/h1&gt;
&lt;p&gt;Check mysql logs to see connection is indeed through SSL:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo cat&lt;/span&gt; /var/log/mysql/error.log | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;ssl
2020-06-20 11:24:04 0 &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Note] WSREP: initializing ssl context
2020-06-20 11:24:04 0 &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Note] WSREP: &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;38f78cdc-ac66, &lt;span class=&quot;s1&quot;&gt;'ssl://0.0.0.0:4567'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; listening at ssl://0.0.0.0:4567
2020-06-20 11:24:04 0 &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Note] WSREP: &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;38f78cdc-ac66, &lt;span class=&quot;s1&quot;&gt;'ssl://0.0.0.0:4567'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; multicast: , ttl: 1
2020-06-20 11:24:04 0 &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Note] WSREP: SSL handshake successful, remote endpoint ssl://XXX:4567 &lt;span class=&quot;nb&quot;&gt;local &lt;/span&gt;endpoint ssl://XXX:46756 cipher: TLS_AES_256_GCM_SHA384 compression: none
2020-06-20 11:24:04 0 &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Note] WSREP: SSL handshake successful, remote endpoint ssl://XXX:4567 &lt;span class=&quot;nb&quot;&gt;local &lt;/span&gt;endpoint ssl://XXX:57914 cipher: TLS_AES_256_GCM_SHA384 compression: none
2020-06-20 11:24:04 0 &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Note] WSREP: SSL handshake successful, remote endpoint ssl://XXX:4567 &lt;span class=&quot;nb&quot;&gt;local &lt;/span&gt;endpoint ssl://XXX:59148 cipher: TLS_AES_256_GCM_SHA384 compression: none
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h1 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h1&gt;
&lt;p&gt;This post guides us how to set up and secure a 3-node Galera cluster. Next post will cover setting up proxy to connect a client to multiple Mariadb nodes securely using stunnel and configure load balancer with HAProxy.&lt;/p&gt;

&lt;h1 id=&quot;resources&quot;&gt;Resources&lt;/h1&gt;
&lt;p&gt;&lt;a href=&quot;https://jasonthai.me/blog/2020/06/08/high-availability-series-part-i-set-up-and-secure-mariadb-on-debian-servers/&quot;&gt;[High Availability Series] PART I: Set Up and Use SSL to Secure MariaDB on Debian Servers&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://galeracluster.com/library/documentation/ssl-config.html&quot;&gt;https://galeracluster.com/library/documentation/ssl-config.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://galeracluster.com/library/documentation/firewall-settings.html&quot;&gt;https://galeracluster.com/library/documentation/firewall-settings.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://mariadb.com/kb/en/getting-started-with-mariadb-galera-cluster&quot;&gt;https://mariadb.com/kb/en/getting-started-with-mariadb-galera-cluster&lt;/a&gt;&lt;/p&gt;</content><author><name>Jason Thai</name></author><category term="tech" /><category term="en" /><summary type="html">Introduction Second part of the series covers how to set up and secure a multi master Galera cluster consisting of 3 mariadb servers. A multi master cluster allow reads and writes from any of the nodes. Changes are replicated synchronously to the other nodes. We will go over how to set it up and secure the communication between the three nodes. There are 3 different vectors that we can secure through SSL: traffic between the database server and client, replication traffic within Galera Cluster, and the State Snapshot Transfer (SST). We will go over all three. Initial Configuration: On every node of the cluster, add the following lines in /etc/hosts: IP-of-node1 galera-01 IP-of-node2 galera-02 IP-of-node3 galera-03 Optional: Setting up the firewall to only allow cluster traffic communication between the three nodes with ufw. Galera requires a number of ports for connectivity between its nodes. Below is the list: 3306 is the default port for MySQL client connections and State Snapshot Transfer using mysqldump for backups. 4567 is reserved for Galera Cluster replication traffic. Multicast replication uses both TCP and UDP transport on this port. 4568 is the port for Incremental State Transfer. 4444 is used for all other State Snapshot Transfer. Example of ufw configuration on node1: $galera-01 sudo ufw allow from IP-of-node2 to any port 3306 proto tcp $galera-01 sudo ufw allow from IP-of-node2 to any port 4444 proto tcp $galera-01 sudo ufw allow from IP-of-node2 to any port 4567 proto tcp $galera-01 sudo ufw allow from IP-of-node2 to any port 4568 proto tcp $galera-01 sudo ufw allow from IP-of-node2 to any port 4567 proto udp $galera-01 sudo ufw allow from IP-of-node3 to any port 3306 proto tcp $galera-01 sudo ufw allow from IP-of-node3 to any port 4444 proto tcp $galera-01 sudo ufw allow from IP-of-node3 to any port 4567 proto tcp $galera-01 sudo ufw allow from IP-of-node3 to any port 4568 proto tcp $galera-01 sudo ufw allow from IP-of-node3 to any port 4567 proto udp $galera-01 sudo ufw reload Configure the first node: Following the the first part of the series, we have covered securing the traffic between the server and the client. Now we are ready to initialize the first node of the cluster. Create /etc/mysql/mariadb.conf.d/galera.cnf and add the following lines: [mysqld] binlog_format=ROW default-storage-engine=innodb innodb_autoinc_lock_mode=2 bind-address=0.0.0.0 # Galera Provider Configuration wsrep_on=ON wsrep_provider=/usr/lib/galera/libgalera_smm.so # Configuration to secure traffic replication wsrep_provider_options=&quot;socket.ssl_key=/etc/mysql/certs/server-key.pem;socket.ssl_cert=/etc/mysql/certs/server-cert.pem;socket.ssl_ca=/etc/mysql/certs/ca-cert.pem&quot; # Galera Cluster Configuration wsrep_cluster_name=&quot;galera_cluster&quot; wsrep_cluster_address=&quot;gcomm://galera-01,galera-02,galera-03&quot; # Galera Synchronization Configuration wsrep_sst_auth=xtra:replace-your-verify-secure-replication-password-here wsrep_sst_method=mariabackup # Galera Node Configuration wsrep_node_address=galera-01 wsrep_node_name=galera-db-01 # Configuration to secure the SST connection [sst] encrypt=3 tcert=/etc/mysql/certs/server-cert.pem tkey=/etc/mysql/certs/server-key.pem Inititialize Galera cluster: $galera-01 sudo systemctl stop mariadb $galera-01 sudo galera_new_cluster $galera-01 sudo systemctl status mariadb Configure the second node: Following part I of the series, we have created all the necessary certs in node 1 of the cluster. We do not have to create the certs again, simply copy the certs from the first node to the second node and place them in /etc/mysql/certs Create /etc/mysql/mariadb.conf.d/galera.cnf and add the following lines: [mysqld] binlog_format=ROW default-storage-engine=innodb innodb_autoinc_lock_mode=2 bind-address=0.0.0.0 # Galera Provider Configuration wsrep_on=ON wsrep_provider=/usr/lib/galera/libgalera_smm.so # Configuration to secure traffic replication wsrep_provider_options=&quot;socket.ssl_key=/etc/mysql/certs/server-key.pem;socket.ssl_cert=/etc/mysql/certs/server-cert.pem;socket.ssl_ca=/etc/mysql/certs/ca-cert.pem&quot; # Galera Cluster Configuration wsrep_cluster_name=&quot;galera_cluster&quot; wsrep_cluster_address=&quot;gcomm://galera-01,galera-02,galera-03&quot; # Galera Synchronization Configuration wsrep_sst_auth=xtra:replace-your-verify-secure-replication-password-here wsrep_sst_method=mariabackup # Galera Node Configuration wsrep_node_address=galera-02 wsrep_node_name=galera-db-02 # Configuration to secure the SST connection [sst] encrypt=3 tcert=/etc/mysql/certs/server-cert.pem tkey=/etc/mysql/certs/server-key.pem Restart Mariadb $galera-02 sudo systemctl restart mariadb Configure the third node: Again copy the certs from the first node to the third node and place them in /etc/mysql/certs Create /etc/mysql/mariadb.conf.d/galera.cnf and add the following lines: [mysqld] binlog_format=ROW default-storage-engine=innodb innodb_autoinc_lock_mode=2 bind-address=0.0.0.0 # Galera Provider Configuration wsrep_on=ON wsrep_provider=/usr/lib/galera/libgalera_smm.so # Configuration to secure traffic replication wsrep_provider_options=&quot;socket.ssl_key=/etc/mysql/certs/server-key.pem;socket.ssl_cert=/etc/mysql/certs/server-cert.pem;socket.ssl_ca=/etc/mysql/certs/ca-cert.pem&quot; # Galera Cluster Configuration wsrep_cluster_name=&quot;galera_cluster&quot; wsrep_cluster_address=&quot;gcomm://galera-01,galera-02,galera-03&quot; # Galera Synchronization Configuration wsrep_sst_auth=xtra:replace-your-verify-secure-replication-password-here wsrep_sst_method=mariabackup # Galera Node Configuration wsrep_node_address=galera-03 wsrep_node_name=galera-db-03 # Configuration to secure the SST connection [sst] encrypt=3 tcert=/etc/mysql/certs/server-cert.pem tkey=/etc/mysql/certs/server-key.pem Restart Mariadb $galera-03 sudo systemctl restart mariadb Verify MariaDB Galera Cluster Settings Login to MySQL console from a node in the cluster as root user. Welcome to the MariaDB monitor. Commands end with ; or \g. Your MariaDB connection id is 122994 Server version: 10.4.13-MariaDB-1:10.4.13+maria~buster mariadb.org binary distribution Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others. Type 'help;' or '\h' for help. Type '\c' to clear the current input statement. MariaDB [(none)]&amp;gt; Check the cluster size: MariaDB [(none)]&amp;gt; SHOW STATUS LIKE 'wsrep_cluster_size'; +--------------------+-------+ | Variable_name | Value | +--------------------+-------+ | wsrep_cluster_size | 3 | +--------------------+-------+ 1 row in set (0.001 sec) To view all status related to cluster: MariaDB [(none)]&amp;gt; SHOW GLOBAL STATUS LIKE 'wsrep_%'; Verify Cluster Replication On node1: $galera-01 sudo mysql Welcome to the MariaDB monitor. Commands end with ; or \g. Your MariaDB connection id is 118912 Server version: 10.4.13-MariaDB-1:10.4.13+maria~buster mariadb.org binary distribution Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others. Type 'help;' or '\h' for help. Type '\c' to clear the current input statement. MariaDB [(none)]&amp;gt; create database test1; Query OK, 1 row affected (0.033 sec) MariaDB [(none)]&amp;gt; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | mysql | | performance_schema | | test1 | +--------------------+ 4 rows in set (0.410 sec) On node 2 or 3: $galera-03 sudo mysql Welcome to the MariaDB monitor. Commands end with ; or \g. Your MariaDB connection id is 124058 Server version: 10.4.13-MariaDB-1:10.4.13+maria~buster mariadb.org binary distribution Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others. Type 'help;' or '\h' for help. Type '\c' to clear the current input statement. MariaDB [(none)]&amp;gt; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | mysql | | performance_schema | | test1 | +--------------------+ 4 rows in set (0.954 sec) Verify Secure Connection Between Nodes Check mysql logs to see connection is indeed through SSL: $galera-01 sudo cat /var/log/mysql/error.log | grep ssl 2020-06-20 11:24:04 0 [Note] WSREP: initializing ssl context 2020-06-20 11:24:04 0 [Note] WSREP: (38f78cdc-ac66, 'ssl://0.0.0.0:4567') listening at ssl://0.0.0.0:4567 2020-06-20 11:24:04 0 [Note] WSREP: (38f78cdc-ac66, 'ssl://0.0.0.0:4567') multicast: , ttl: 1 2020-06-20 11:24:04 0 [Note] WSREP: SSL handshake successful, remote endpoint ssl://XXX:4567 local endpoint ssl://XXX:46756 cipher: TLS_AES_256_GCM_SHA384 compression: none 2020-06-20 11:24:04 0 [Note] WSREP: SSL handshake successful, remote endpoint ssl://XXX:4567 local endpoint ssl://XXX:57914 cipher: TLS_AES_256_GCM_SHA384 compression: none 2020-06-20 11:24:04 0 [Note] WSREP: SSL handshake successful, remote endpoint ssl://XXX:4567 local endpoint ssl://XXX:59148 cipher: TLS_AES_256_GCM_SHA384 compression: none Conclusion This post guides us how to set up and secure a 3-node Galera cluster. Next post will cover setting up proxy to connect a client to multiple Mariadb nodes securely using stunnel and configure load balancer with HAProxy. Resources [High Availability Series] PART I: Set Up and Use SSL to Secure MariaDB on Debian Servers https://galeracluster.com/library/documentation/ssl-config.html https://galeracluster.com/library/documentation/firewall-settings.html https://mariadb.com/kb/en/getting-started-with-mariadb-galera-cluster</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jasonthai.me/assets/img/galera_small.png" /><media:content medium="image" url="https://jasonthai.me/assets/img/galera_small.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">[High Availability Series] PART I: Set Up and Use SSL to Secure MariaDB on Debian Servers</title><link href="https://jasonthai.me/blog/2020/06/08/high-availability-series-part-i-set-up-and-secure-mariadb-on-debian-servers/" rel="alternate" type="text/html" title="[High Availability Series] PART I: Set Up and Use SSL to Secure MariaDB on Debian Servers" /><published>2020-06-08T00:00:00+00:00</published><updated>2020-06-08T00:00:00+00:00</updated><id>https://jasonthai.me/blog/2020/06/08/high-availability-series-part-i-set-up-and-secure-mariadb-on-debian-servers</id><content type="html" xml:base="https://jasonthai.me/blog/2020/06/08/high-availability-series-part-i-set-up-and-secure-mariadb-on-debian-servers/">&lt;h1 id=&quot;introduction&quot;&gt;Introduction&lt;/h1&gt;
&lt;p&gt;First part of the series covers how to set up and secure MariaDB.&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;MariaDB is a community-developed, commercially supported fork of the MySQL relational database management system, intended to remain free and open-source software under the GNU General Public License
&lt;a href=&quot;https://en.wikipedia.org/wiki/MariaDB&quot;&gt;https://en.wikipedia.org/wiki/MariaDB&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The series will guide through how to set up a Galera cluster with 3 nodes, secure connection between them, and finally set up HAProxy as a load balancer to the webservers where each webserver talks to a particular MariaDB instance on the same server. This purpose is to have a highly available and endurable system which is expected to run continuously without failure for a long time. This only covers horizontal scaling of different nodes. Vertical scaling may be covered in the future.&lt;/p&gt;

&lt;h1 id=&quot;set-up-mariadb&quot;&gt;Set up MariaDB&lt;/h1&gt;
&lt;p&gt;Install MariaDB packages:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt-get &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;mariadb-server mariadb-backup
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Run the security script:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;mysql_secure_installation
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;details&gt;
    &lt;summary&gt;Sample output:
&lt;/summary&gt;
    
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB
      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!

In order to log into MariaDB to secure it, we&lt;span class=&quot;s1&quot;&gt;'ll need the current
password for the root user.  If you'&lt;/span&gt;ve just installed MariaDB, and
you haven&lt;span class=&quot;s1&quot;&gt;'t set the root password yet, the password will be blank,
so you should just press enter here.

Enter current password for root (enter for none):
OK, successfully used password, moving on...

Setting the root password ensures that nobody can log into the MariaDB
root user without the proper authorisation.

Set root password? [Y/n] Y
New password:
Re-enter new password:
Password updated successfully!
Reloading privilege tables..
 ... Success!


By default, a MariaDB installation has an anonymous user, allowing anyone
to log into MariaDB without having to have a user account created for
them.  This is intended only for testing, and to make the installation
go a bit smoother.  You should remove them before moving into a
production environment.

Remove anonymous users? [Y/n] Y
 ... Success!

Normally, root should only be allowed to connect from '&lt;/span&gt;localhost&lt;span class=&quot;s1&quot;&gt;'.  This
ensures that someone cannot guess at the root password from the network.

Disallow root login remotely? [Y/n] Y
 ... Success!

By default, MariaDB comes with a database named '&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;' that anyone can
access.  This is also intended only for testing, and should be removed
before moving into a production environment.

Remove test database and access to it? [Y/n] Y
 - Dropping test database...
 ... Success!
 - Removing privileges on test database...
 ... Success!

Reloading the privilege tables will ensure that all changes made so far
will take effect immediately.

Reload privilege tables now? [Y/n] Y
 ... Success!

Cleaning up...

All done!  If you'&lt;/span&gt;ve completed all of the above steps, your MariaDB
installation should now be secure.

Thanks &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;using MariaDB!
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;/details&gt;
&lt;h1 id=&quot;set-up-ssl-for-mariadb&quot;&gt;Set up SSL for MariaDB&lt;/h1&gt;
&lt;h2 id=&quot;create-ca-certificate&quot;&gt;Create CA Certificate&lt;/h2&gt;
&lt;p&gt;Make a directory named certs in /etc/mysql/ directory using the mkdir command:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /etc/mysql
&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo mkdir &lt;/span&gt;certs
&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;certs
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note: Common Name value used for the server and client certificates/keys must each differ from the Common Name value used for the CA certificate. To avoid any issues, set it as follows:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;CA common Name : MariaDB admin&lt;/li&gt;
  &lt;li&gt;Server common Name: MariaDB server&lt;/li&gt;
  &lt;li&gt;Client common Name: MariaDB client&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Type the following command to create a new CA key:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;openssl genrsa 2048 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; ca-key.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;OR&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;openssl genrsa 4096 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; ca-key.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;details&gt;
    &lt;summary&gt;Sample output:
&lt;/summary&gt;
    
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Generating RSA private key, 2048 bit long modulus &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;2 primes&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
.......+++++
..............................................................+++++
e is 65537 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0x010001&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;/details&gt;

&lt;p&gt;Type the following command to generate the certificate using that key:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;openssl req &lt;span class=&quot;nt&quot;&gt;-new&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-x509&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-nodes&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-days&lt;/span&gt; 365000 &lt;span class=&quot;nt&quot;&gt;-key&lt;/span&gt; ca-key.pem &lt;span class=&quot;nt&quot;&gt;-out&lt;/span&gt; ca-cert.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;details&gt;
    &lt;summary&gt;Sample output:
&lt;/summary&gt;
    
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &lt;span class=&quot;s1&quot;&gt;'.'&lt;/span&gt;, the field will be left blank.
&lt;span class=&quot;nt&quot;&gt;-----&lt;/span&gt;
Country Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;2 letter code&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;AU]:
State or Province Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;full name&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Some-State]:
Locality Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;eg, city&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:
Organization Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;eg, company&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Internet Widgits Pty Ltd]:
Organizational Unit Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;eg, section&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:
Common Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;e.g. server FQDN or YOUR name&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:MariaDB admin
Email Address &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;/details&gt;

&lt;p&gt;Now there should be two files as follows:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; /etc/mysql/certs
ca-cert.pem – Certificate file &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the Certificate Authority &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;CA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
ca-key.pem – Key file &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the Certificate Authority &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;CA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Let’s use both files to generate the server and client certificates.&lt;/p&gt;
&lt;h2 id=&quot;create-the-server-ssl-certificate&quot;&gt;Create the server SSL certificate&lt;/h2&gt;
&lt;p&gt;To create the server key, run:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;openssl req &lt;span class=&quot;nt&quot;&gt;-newkey&lt;/span&gt; rsa:2048 &lt;span class=&quot;nt&quot;&gt;-days&lt;/span&gt; 365000 &lt;span class=&quot;nt&quot;&gt;-nodes&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-keyout&lt;/span&gt; server-key.pem &lt;span class=&quot;nt&quot;&gt;-out&lt;/span&gt; server-req.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;details&gt;
    &lt;summary&gt;Sample output:
&lt;/summary&gt;
    
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Generating a RSA private key
.........................................................................................................................................+++++
...........................................................+++++
writing new private key to &lt;span class=&quot;s1&quot;&gt;'server-key.pem'&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;-----&lt;/span&gt;
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &lt;span class=&quot;s1&quot;&gt;'.'&lt;/span&gt;, the field will be left blank.
&lt;span class=&quot;nt&quot;&gt;-----&lt;/span&gt;
Country Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;2 letter code&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;AU]:
State or Province Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;full name&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Some-State]:
Locality Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;eg, city&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:
Organization Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;eg, company&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Internet Widgits Pty Ltd]:
Organizational Unit Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;eg, section&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:
Common Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;e.g. server FQDN or YOUR name&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:MariaDB server
Email Address &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:

Please enter the following &lt;span class=&quot;s1&quot;&gt;'extra'&lt;/span&gt; attributes
to be sent with your certificate request
A challenge password &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:
An optional company name &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;/details&gt;

&lt;p&gt;Next process the server RSA key, enter:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;openssl rsa &lt;span class=&quot;nt&quot;&gt;-in&lt;/span&gt; server-key.pem &lt;span class=&quot;nt&quot;&gt;-out&lt;/span&gt; server-key.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;details&gt;
    &lt;summary&gt;Sample output:
&lt;/summary&gt;
    
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;writing RSA key
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;/details&gt;

&lt;p&gt;Finally sign the server certificate, run:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;openssl x509 &lt;span class=&quot;nt&quot;&gt;-req&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-in&lt;/span&gt; server-req.pem &lt;span class=&quot;nt&quot;&gt;-days&lt;/span&gt; 365000 &lt;span class=&quot;nt&quot;&gt;-CA&lt;/span&gt; ca-cert.pem &lt;span class=&quot;nt&quot;&gt;-CAkey&lt;/span&gt; ca-key.pem &lt;span class=&quot;nt&quot;&gt;-set_serial&lt;/span&gt; 01 &lt;span class=&quot;nt&quot;&gt;-out&lt;/span&gt; server-cert.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;details&gt;
    &lt;summary&gt;Sample output:
&lt;/summary&gt;
    
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Signature ok
&lt;span class=&quot;nv&quot;&gt;subject&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;C &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; AU, ST &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Some-State, O &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Internet Widgits Pty Ltd, CN &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; MariaDB server
Getting CA Private Key
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;/details&gt;

&lt;p&gt;Now you should have these two additional files:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;/etc/mysql/certs/server-cert.pem – MariaDB server certificate file.
/etc/mysql/certs/server-key.pem – MariaDB server key file.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;create-the-client-tlsssl-certificate&quot;&gt;Create the client TLS/SSL certificate&lt;/h2&gt;
&lt;p&gt;To create the client key, run:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;openssl req &lt;span class=&quot;nt&quot;&gt;-newkey&lt;/span&gt; rsa:2048 &lt;span class=&quot;nt&quot;&gt;-days&lt;/span&gt; 365000 &lt;span class=&quot;nt&quot;&gt;-nodes&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-keyout&lt;/span&gt; client-key.pem &lt;span class=&quot;nt&quot;&gt;-out&lt;/span&gt; client-req.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;details&gt;
    &lt;summary&gt;Sample output:
&lt;/summary&gt;
    
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Generating a RSA private key
.......................................+++++
...............+++++
writing new private key to &lt;span class=&quot;s1&quot;&gt;'client-key.pem'&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;-----&lt;/span&gt;
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &lt;span class=&quot;s1&quot;&gt;'.'&lt;/span&gt;, the field will be left blank.
&lt;span class=&quot;nt&quot;&gt;-----&lt;/span&gt;
Country Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;2 letter code&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;AU]:
State or Province Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;full name&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Some-State]:
Locality Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;eg, city&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:
Organization Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;eg, company&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Internet Widgits Pty Ltd]:
Organizational Unit Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;eg, section&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:
Common Name &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;e.g. server FQDN or YOUR name&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:Mariadb client
Email Address &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:

Please enter the following &lt;span class=&quot;s1&quot;&gt;'extra'&lt;/span&gt; attributes
to be sent with your certificate request
A challenge password &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:
An optional company name &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;/details&gt;

&lt;p&gt;Next, process client RSA key, enter:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;openssl rsa &lt;span class=&quot;nt&quot;&gt;-in&lt;/span&gt; client-key.pem &lt;span class=&quot;nt&quot;&gt;-out&lt;/span&gt; client-key.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;details&gt;
    &lt;summary&gt;Sample output:
&lt;/summary&gt;
    
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;writing RSA key
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;/details&gt;
&lt;p&gt;Finally, sign the client certificate, run:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;openssl x509 &lt;span class=&quot;nt&quot;&gt;-req&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-in&lt;/span&gt; client-req.pem &lt;span class=&quot;nt&quot;&gt;-days&lt;/span&gt; 365000 &lt;span class=&quot;nt&quot;&gt;-CA&lt;/span&gt; ca-cert.pem &lt;span class=&quot;nt&quot;&gt;-CAkey&lt;/span&gt; ca-key.pem &lt;span class=&quot;nt&quot;&gt;-set_serial&lt;/span&gt; 01 &lt;span class=&quot;nt&quot;&gt;-out&lt;/span&gt; client-cert.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;details&gt;
    &lt;summary&gt;Sample output:
&lt;/summary&gt;
    
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Signature ok
&lt;span class=&quot;nv&quot;&gt;subject&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/C&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;AU/ST&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Some-State/O&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Internet Widgits Pty Ltd/CN&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;MariaDB client
Getting CA Private Key
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;/details&gt;
&lt;h2 id=&quot;verify-the-certificates&quot;&gt;Verify the certificates&lt;/h2&gt;
&lt;p&gt;Type the following command to verify the certificates to make sure everything was created correctly:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; openssl verify &lt;span class=&quot;nt&quot;&gt;-CAfile&lt;/span&gt; ca-cert.pem server-cert.pem client-cert.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;details&gt;
    &lt;summary&gt;Sample output:
&lt;/summary&gt;
    
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;server-cert.pem: OK
client-cert.pem: OK
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;/details&gt;
&lt;h2 id=&quot;configure-ssl-for-mariadb-server&quot;&gt;Configure SSL for MariaDB Server&lt;/h2&gt;
&lt;p&gt;Edit &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/mysql/mariadb.conf.d/50-server.cnf&lt;/code&gt; and add the following lines in [mysqld] section:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ssl-ca&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/mysql/certs/ca-cert.pem
ssl-cert&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/mysql/certs/server-cert.pem
ssl-key&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/mysql/certs/server-key.pem
bind-address            &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;      
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Give permission to mysql so it can read the certs properly:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo chown&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Rv&lt;/span&gt; mysql:root /etc/mysql/certs/

changed ownership of &lt;span class=&quot;s1&quot;&gt;'/etc/mysql/certs/server-key.pem'&lt;/span&gt; from root:root to mysql:root
changed ownership of &lt;span class=&quot;s1&quot;&gt;'/etc/mysql/certs/client-req.pem'&lt;/span&gt; from root:root to mysql:root
changed ownership of &lt;span class=&quot;s1&quot;&gt;'/etc/mysql/certs/server-req.pem'&lt;/span&gt; from root:root to mysql:root
changed ownership of &lt;span class=&quot;s1&quot;&gt;'/etc/mysql/certs/ca-key.pem'&lt;/span&gt; from root:root to mysql:root
changed ownership of &lt;span class=&quot;s1&quot;&gt;'/etc/mysql/certs/server-cert.pem'&lt;/span&gt; from root:root to mysql:root
changed ownership of &lt;span class=&quot;s1&quot;&gt;'/etc/mysql/certs/client-cert.pem'&lt;/span&gt; from root:root to mysql:root
changed ownership of &lt;span class=&quot;s1&quot;&gt;'/etc/mysql/certs/ca-cert.pem'&lt;/span&gt; from root:root to mysql:root
changed ownership of &lt;span class=&quot;s1&quot;&gt;'/etc/mysql/certs/client-key.pem'&lt;/span&gt; from root:root to mysql:root
changed ownership of &lt;span class=&quot;s1&quot;&gt;'/etc/mysql/certs/'&lt;/span&gt; from root:root to mysql:root
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then, restart MariaDB service to apply the changes:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl restart mysql
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Next, log in to MariaDB shell and check SSL variable:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;mysql &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; root &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Enter your root password, then run the following command:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; SHOW VARIABLES LIKE &lt;span class=&quot;s1&quot;&gt;'%ssl%'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You will see that SSL variables are now enabled:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;+---------------------+----------------------------------+
| Variable_name       | Value                            |
+---------------------+----------------------------------+
| have_openssl        | NO                               |
| have_ssl            | YES                              |
| ssl_ca              | /etc/mysql/certs/ca-cert.pem     |
| ssl_capath          |                                  |
| ssl_cert            | /etc/mysql/certs/server-cert.pem |
| ssl_cipher          |                                  |
| ssl_crl             |                                  |
| ssl_crlpath         |                                  |
| ssl_key             | /etc/mysql/certs/server-key.pem  |
| version_ssl_library | YaSSL 2.4.4                      |
+---------------------+----------------------------------+
10 rows &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.001 sec&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;configure-ssl-for-mariadb-client&quot;&gt;Configure SSL for MariaDB Client&lt;/h2&gt;
&lt;p&gt;Edit &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/mysql/mariadb.conf.d/50-client.cnf&lt;/code&gt; and add the following lines in [client] section:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ssl-ca&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/mysql/certs/ca-cert.pem
ssl-cert&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/mysql/certs/client-cert.pem
ssl-key&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/mysql/certs/client-key.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;verify-secure-connection&quot;&gt;Verify Secure Connection&lt;/h2&gt;
&lt;p&gt;Log in to MariaDB shell:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$galera&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-01&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;mysql &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; root &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, check the status of connection with the following command:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;mysql]&amp;gt; status
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Detail about secure connection should be displayed like so:&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;--------------&lt;/span&gt;
mysql  Ver 15.1 Distrib 10.3.22-MariaDB, &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;debian-linux-gnu &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;x86_64&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; using readline 5.2

Connection &lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt;:		282
Current database:
Current user:		root@localhost
SSL:			Cipher &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;use is DHE-RSA-AES256-SHA
Current pager:		stdout
Using outfile:		&lt;span class=&quot;s1&quot;&gt;''&lt;/span&gt;
Using delimiter:	&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
Server:			MariaDB
Server version:		10.3.22-MariaDB-0+deb10u1 Debian 10
Protocol version:	10
Connection:		Localhost via UNIX socket
Server characterset:	utf8mb4
Db     characterset:	utf8mb4
Client characterset:	utf8mb4
Conn.  characterset:	utf8mb4
UNIX socket:		/var/run/mysqld/mysqld.sock
Uptime:			7 hours 27 min 20 sec

Threads: 10  Questions: 31302  Slow queries: 0  Opens: 159  Flush tables: 1  Open tables: 63  Queries per second avg: 1.166
&lt;span class=&quot;nt&quot;&gt;--------------&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h1 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h1&gt;
&lt;p&gt;This post guides us how to set up a MariaDB server and secure connection between the server and its clients. Next post will cover setting up the Galera cluster.&lt;/p&gt;

&lt;h1 id=&quot;resources&quot;&gt;Resources&lt;/h1&gt;
&lt;p&gt;&lt;a href=&quot;https://mariadb.com/kb/en/secure-connections-overview&quot;&gt;https://mariadb.com/kb/en/secure-connections-overview&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://mariadb.com/kb/en/securing-connections-for-client-and-server&quot;&gt;https://mariadb.com/kb/en/securing-connections-for-client-and-server&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://jasonthai.me/blog/2020/06/20/high-availability-series-part-ii-configure-and-secure-a-3-node-galera-cluster/&quot;&gt;[High Availability Series] PART II: Configure and Secure a 3-node Galera Cluster&lt;/a&gt;&lt;/p&gt;</content><author><name>Jason Thai</name></author><category term="tech" /><category term="en" /><summary type="html">Introduction First part of the series covers how to set up and secure MariaDB. MariaDB is a community-developed, commercially supported fork of the MySQL relational database management system, intended to remain free and open-source software under the GNU General Public License https://en.wikipedia.org/wiki/MariaDB The series will guide through how to set up a Galera cluster with 3 nodes, secure connection between them, and finally set up HAProxy as a load balancer to the webservers where each webserver talks to a particular MariaDB instance on the same server. This purpose is to have a highly available and endurable system which is expected to run continuously without failure for a long time. This only covers horizontal scaling of different nodes. Vertical scaling may be covered in the future. Set up MariaDB Install MariaDB packages: $galera-01 sudo apt-get install mariadb-server mariadb-backup Run the security script: $galera-01 sudo mysql_secure_installation Sample output: NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB SERVERS IN PRODUCTION USE! PLEASE READ EACH STEP CAREFULLY! In order to log into MariaDB to secure it, we'll need the current password for the root user. If you've just installed MariaDB, and you haven't set the root password yet, the password will be blank, so you should just press enter here. Enter current password for root (enter for none): OK, successfully used password, moving on... Setting the root password ensures that nobody can log into the MariaDB root user without the proper authorisation. Set root password? [Y/n] Y New password: Re-enter new password: Password updated successfully! Reloading privilege tables.. ... Success! By default, a MariaDB installation has an anonymous user, allowing anyone to log into MariaDB without having to have a user account created for them. This is intended only for testing, and to make the installation go a bit smoother. You should remove them before moving into a production environment. Remove anonymous users? [Y/n] Y ... Success! Normally, root should only be allowed to connect from 'localhost'. This ensures that someone cannot guess at the root password from the network. Disallow root login remotely? [Y/n] Y ... Success! By default, MariaDB comes with a database named 'test' that anyone can access. This is also intended only for testing, and should be removed before moving into a production environment. Remove test database and access to it? [Y/n] Y - Dropping test database... ... Success! - Removing privileges on test database... ... Success! Reloading the privilege tables will ensure that all changes made so far will take effect immediately. Reload privilege tables now? [Y/n] Y ... Success! Cleaning up... All done! If you've completed all of the above steps, your MariaDB installation should now be secure. Thanks for using MariaDB! Set up SSL for MariaDB Create CA Certificate Make a directory named certs in /etc/mysql/ directory using the mkdir command: $galera-01 cd /etc/mysql $galera-01 sudo mkdir certs $galera-01 cd certs Note: Common Name value used for the server and client certificates/keys must each differ from the Common Name value used for the CA certificate. To avoid any issues, set it as follows: CA common Name : MariaDB admin Server common Name: MariaDB server Client common Name: MariaDB client Type the following command to create a new CA key: $galera-01 sudo openssl genrsa 2048 &amp;gt; ca-key.pem OR $galera-01 sudo openssl genrsa 4096 &amp;gt; ca-key.pem Sample output: Generating RSA private key, 2048 bit long modulus (2 primes) .......+++++ ..............................................................+++++ e is 65537 (0x010001) Type the following command to generate the certificate using that key: $galera-01 sudo openssl req -new -x509 -nodes -days 365000 -key ca-key.pem -out ca-cert.pem Sample output: You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]: State or Province Name (full name) [Some-State]: Locality Name (eg, city) []: Organization Name (eg, company) [Internet Widgits Pty Ltd]: Organizational Unit Name (eg, section) []: Common Name (e.g. server FQDN or YOUR name) []:MariaDB admin Email Address []: Now there should be two files as follows: $galera-01 ls /etc/mysql/certs ca-cert.pem – Certificate file for the Certificate Authority (CA). ca-key.pem – Key file for the Certificate Authority (CA). Let’s use both files to generate the server and client certificates. Create the server SSL certificate To create the server key, run: $galera-01 sudo openssl req -newkey rsa:2048 -days 365000 -nodes -keyout server-key.pem -out server-req.pem Sample output: Generating a RSA private key .........................................................................................................................................+++++ ...........................................................+++++ writing new private key to 'server-key.pem' ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]: State or Province Name (full name) [Some-State]: Locality Name (eg, city) []: Organization Name (eg, company) [Internet Widgits Pty Ltd]: Organizational Unit Name (eg, section) []: Common Name (e.g. server FQDN or YOUR name) []:MariaDB server Email Address []: Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []: An optional company name []: Next process the server RSA key, enter: $galera-01 sudo openssl rsa -in server-key.pem -out server-key.pem Sample output: writing RSA key Finally sign the server certificate, run: $galera-01 sudo openssl x509 -req -in server-req.pem -days 365000 -CA ca-cert.pem -CAkey ca-key.pem -set_serial 01 -out server-cert.pem Sample output: Signature ok subject=C = AU, ST = Some-State, O = Internet Widgits Pty Ltd, CN = MariaDB server Getting CA Private Key Now you should have these two additional files: /etc/mysql/certs/server-cert.pem – MariaDB server certificate file. /etc/mysql/certs/server-key.pem – MariaDB server key file. Create the client TLS/SSL certificate To create the client key, run: $galera-01 sudo openssl req -newkey rsa:2048 -days 365000 -nodes -keyout client-key.pem -out client-req.pem Sample output: Generating a RSA private key .......................................+++++ ...............+++++ writing new private key to 'client-key.pem' ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]: State or Province Name (full name) [Some-State]: Locality Name (eg, city) []: Organization Name (eg, company) [Internet Widgits Pty Ltd]: Organizational Unit Name (eg, section) []: Common Name (e.g. server FQDN or YOUR name) []:Mariadb client Email Address []: Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []: An optional company name []: Next, process client RSA key, enter: $galera-01 sudo openssl rsa -in client-key.pem -out client-key.pem Sample output: writing RSA key Finally, sign the client certificate, run: $galera-01 sudo openssl x509 -req -in client-req.pem -days 365000 -CA ca-cert.pem -CAkey ca-key.pem -set_serial 01 -out client-cert.pem Sample output: Signature ok subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd/CN=MariaDB client Getting CA Private Key Verify the certificates Type the following command to verify the certificates to make sure everything was created correctly: $galera-01 openssl verify -CAfile ca-cert.pem server-cert.pem client-cert.pem Sample output: server-cert.pem: OK client-cert.pem: OK Configure SSL for MariaDB Server Edit /etc/mysql/mariadb.conf.d/50-server.cnf and add the following lines in [mysqld] section: ssl-ca=/etc/mysql/certs/ca-cert.pem ssl-cert=/etc/mysql/certs/server-cert.pem ssl-key=/etc/mysql/certs/server-key.pem bind-address = * Give permission to mysql so it can read the certs properly: $galera-01 sudo chown -Rv mysql:root /etc/mysql/certs/ changed ownership of '/etc/mysql/certs/server-key.pem' from root:root to mysql:root changed ownership of '/etc/mysql/certs/client-req.pem' from root:root to mysql:root changed ownership of '/etc/mysql/certs/server-req.pem' from root:root to mysql:root changed ownership of '/etc/mysql/certs/ca-key.pem' from root:root to mysql:root changed ownership of '/etc/mysql/certs/server-cert.pem' from root:root to mysql:root changed ownership of '/etc/mysql/certs/client-cert.pem' from root:root to mysql:root changed ownership of '/etc/mysql/certs/ca-cert.pem' from root:root to mysql:root changed ownership of '/etc/mysql/certs/client-key.pem' from root:root to mysql:root changed ownership of '/etc/mysql/certs/' from root:root to mysql:root Then, restart MariaDB service to apply the changes: $galera-01 sudo systemctl restart mysql Next, log in to MariaDB shell and check SSL variable: $galera-01 sudo mysql -u root -p Enter your root password, then run the following command: MariaDB [(none)]&amp;gt; SHOW VARIABLES LIKE '%ssl%'; You will see that SSL variables are now enabled: +---------------------+----------------------------------+ | Variable_name | Value | +---------------------+----------------------------------+ | have_openssl | NO | | have_ssl | YES | | ssl_ca | /etc/mysql/certs/ca-cert.pem | | ssl_capath | | | ssl_cert | /etc/mysql/certs/server-cert.pem | | ssl_cipher | | | ssl_crl | | | ssl_crlpath | | | ssl_key | /etc/mysql/certs/server-key.pem | | version_ssl_library | YaSSL 2.4.4 | +---------------------+----------------------------------+ 10 rows in set (0.001 sec) Configure SSL for MariaDB Client Edit /etc/mysql/mariadb.conf.d/50-client.cnf and add the following lines in [client] section: ssl-ca=/etc/mysql/certs/ca-cert.pem ssl-cert=/etc/mysql/certs/client-cert.pem ssl-key=/etc/mysql/certs/client-key.pem Verify Secure Connection Log in to MariaDB shell: $galera-01 sudo mysql -u root -p Now, check the status of connection with the following command: MariaDB [mysql]&amp;gt; status Detail about secure connection should be displayed like so: -------------- mysql Ver 15.1 Distrib 10.3.22-MariaDB, for debian-linux-gnu (x86_64) using readline 5.2 Connection id: 282 Current database: Current user: root@localhost SSL: Cipher in use is DHE-RSA-AES256-SHA Current pager: stdout Using outfile: '' Using delimiter: ; Server: MariaDB Server version: 10.3.22-MariaDB-0+deb10u1 Debian 10 Protocol version: 10 Connection: Localhost via UNIX socket Server characterset: utf8mb4 Db characterset: utf8mb4 Client characterset: utf8mb4 Conn. characterset: utf8mb4 UNIX socket: /var/run/mysqld/mysqld.sock Uptime: 7 hours 27 min 20 sec Threads: 10 Questions: 31302 Slow queries: 0 Opens: 159 Flush tables: 1 Open tables: 63 Queries per second avg: 1.166 -------------- Conclusion This post guides us how to set up a MariaDB server and secure connection between the server and its clients. Next post will cover setting up the Galera cluster. Resources https://mariadb.com/kb/en/secure-connections-overview https://mariadb.com/kb/en/securing-connections-for-client-and-server [High Availability Series] PART II: Configure and Secure a 3-node Galera Cluster</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jasonthai.me/assets/img/galera_small.png" /><media:content medium="image" url="https://jasonthai.me/assets/img/galera_small.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">How to Setup Wireguard + Pi-hole on Debian 10 / Ubuntu 18.04</title><link href="https://jasonthai.me/blog/2020/05/01/how-to-setup-wireguard-pi-hole-on-debian-10-ubuntu-1804/" rel="alternate" type="text/html" title="How to Setup Wireguard + Pi-hole on Debian 10 / Ubuntu 18.04" /><published>2020-05-01T00:00:00+00:00</published><updated>2020-05-01T00:00:00+00:00</updated><id>https://jasonthai.me/blog/2020/05/01/how-to-setup-wireguard-pi-hole-on-debian-10-ubuntu-1804</id><content type="html" xml:base="https://jasonthai.me/blog/2020/05/01/how-to-setup-wireguard-pi-hole-on-debian-10-ubuntu-1804/">&lt;blockquote&gt;
  &lt;p&gt;WireGuard® is an extremely simple yet fast and modern VPN that utilizes state-of-the-art cryptography. It aims to be faster, simpler, leaner, and more useful than IPsec, while avoiding the massive headache. It intends to be considerably more performant than OpenVPN. WireGuard is designed as a general purpose VPN for running on embedded interfaces and super computers alike, fit for many different circumstances. Initially released for the Linux kernel, it is now cross-platform (Windows, macOS, BSD, iOS, Android) and widely deployable. It is currently under heavy development, but already it might be regarded as the most secure, easiest to use, and simplest VPN solution in the industry.
&lt;a href=&quot;https://www.wireguard.com/&quot;&gt;https://www.wireguard.com&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Follow up for my post &lt;a href=&quot;https://jasonthai.me/blog/2019/08/25/how-to-host-openvpn-and-pi-hole-on-ubuntu-1804-vps/&quot;&gt;How to host OpenVPN and Pi-hole on Ubuntu 18.04 VPS&lt;/a&gt;. This is a guide to set up wireguard + pi-hole for your own private ad blocking VPN.&lt;/p&gt;

&lt;h2 id=&quot;installation&quot;&gt;Installation&lt;/h2&gt;

&lt;h3 id=&quot;wireguard-setup&quot;&gt;Wireguard Setup&lt;/h3&gt;
&lt;p&gt;Run these scripts:&lt;/p&gt;
&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget https://git.io/wireguard &lt;span class=&quot;nt&quot;&gt;-O&lt;/span&gt; wireguard-install.sh &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; bash wireguard-install.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Follow this setup:&lt;/p&gt;
&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Welcome to this WireGuard road warrior installer!

I need to ask you a few questions before starting setup.
You can use the default options and just press enter &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;you are ok with them.

What IPv4 address should the WireGuard server use?
     1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; Your IPv4 address should show up here
     2&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; other &lt;span class=&quot;nb&quot;&gt;local &lt;/span&gt;IP
IPv4 address &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;1]: 1

What port &lt;span class=&quot;k&quot;&gt;do &lt;/span&gt;you want WireGuard listening to?
Port &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;51820]: 51820

Tell me a name &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the first client.
Client name &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;client]: client

Which DNS &lt;span class=&quot;k&quot;&gt;do &lt;/span&gt;you want to use &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;this client?
   1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; Current system resolvers
   2&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 1.1.1.1
   3&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; Google
   4&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; OpenDNS
   5&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; NTT
   6&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; AdGuard
DNS &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;1]: 2

We are ready to &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;up your WireGuard server now.

Press any key to &lt;span class=&quot;k&quot;&gt;continue&lt;/span&gt;...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;start-wireguard&quot;&gt;Start Wireguard&lt;/h3&gt;
&lt;p&gt;Wireguard should start automatically after you ran the script. If not you can check by&lt;/p&gt;
&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl status wg-quick@wg0.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Restart Wireguard services:&lt;/p&gt;
&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl restart wg-quick@wg0.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;pi-hole-setup&quot;&gt;Pi-hole Setup&lt;/h3&gt;
&lt;p&gt;Note down  Wireguard’s IP:&lt;/p&gt;
&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ip a show dev wg0
10.7.0.1/24 // note this address
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note down your default  gateway IP address:&lt;/p&gt;
&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ip r | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;default
default via XXX.XXX.XXX.XXX dev eth0 onlink // note this address
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Run this script:&lt;/p&gt;
&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-sSL&lt;/span&gt; https://install.pi-hole.net | bash
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Follow the instruction to set up pi-hole:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Installing dependencies&lt;/li&gt;
&lt;/ul&gt;

&lt;picture&gt;
    &lt;source srcset=&quot;https://jasonthai.me/assets/img/pihole-wireguard-1.webp&quot; type=&quot;image/webp&quot; /&gt;
    &lt;img class=&quot;db ml-auto mr-auto&quot; src=&quot;https://jasonthai.me/assets/img/pihole-wireguard-1.png&quot; alt=&quot;step 1&quot; /&gt;
&lt;/picture&gt;

&lt;ul&gt;
  &lt;li&gt;The following step is important, make sure to select &lt;code class=&quot;highlighter-rouge&quot;&gt;wg0&lt;/code&gt; as the interface&lt;/li&gt;
&lt;/ul&gt;

&lt;picture&gt;
    &lt;source srcset=&quot;https://jasonthai.me/assets/img/pihole-wireguard-2.webp&quot; type=&quot;image/webp&quot; /&gt;
    &lt;img class=&quot;db ml-auto mr-auto&quot; src=&quot;https://jasonthai.me/assets/img/pihole-wireguard-2.png&quot; alt=&quot;step 2&quot; /&gt;
&lt;/picture&gt;

&lt;ul&gt;
  &lt;li&gt;Choose the DNS provider Pi-hole will use.&lt;/li&gt;
&lt;/ul&gt;

&lt;picture&gt;
    &lt;source srcset=&quot;https://jasonthai.me/assets/img/pihole-wireguard-3.webp&quot; type=&quot;image/webp&quot; /&gt;
    &lt;img class=&quot;db ml-auto mr-auto&quot; src=&quot;https://jasonthai.me/assets/img/pihole-wireguard-3.png&quot; alt=&quot;step 3&quot; /&gt;
&lt;/picture&gt;

&lt;ul&gt;
  &lt;li&gt;Choose the protocols available to you&lt;/li&gt;
&lt;/ul&gt;

&lt;picture&gt;
    &lt;source srcset=&quot;https://jasonthai.me/assets/img/pihole-wireguard-4.webp&quot; type=&quot;image/webp&quot; /&gt;
    &lt;img class=&quot;db ml-auto mr-auto&quot; src=&quot;https://jasonthai.me/assets/img/pihole-wireguard-4.png&quot; alt=&quot;step 4&quot; /&gt;
&lt;/picture&gt;

&lt;ul&gt;
  &lt;li&gt;This following step is important, make sure to choose &lt;code class=&quot;highlighter-rouge&quot;&gt;no&lt;/code&gt; so we can assign our internal address which is &lt;code class=&quot;highlighter-rouge&quot;&gt;10.7.0.1&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;picture&gt;
    &lt;source srcset=&quot;https://jasonthai.me/assets/img/pihole-wireguard-5.webp&quot; type=&quot;image/webp&quot; /&gt;
    &lt;img class=&quot;db ml-auto mr-auto&quot; src=&quot;https://jasonthai.me/assets/img/pihole-wireguard-5.png&quot; alt=&quot;step 5&quot; /&gt;
&lt;/picture&gt;

&lt;ul&gt;
  &lt;li&gt;Enter &lt;code class=&quot;highlighter-rouge&quot;&gt;10.7.0.1/24&lt;/code&gt;. This is the static address VPN will use to talk to Pi-hole&lt;/li&gt;
&lt;/ul&gt;

&lt;picture&gt;
    &lt;source srcset=&quot;https://jasonthai.me/assets/img/pihole-wireguard-6.webp&quot; type=&quot;image/webp&quot; /&gt;
    &lt;img class=&quot;db ml-auto mr-auto&quot; src=&quot;https://jasonthai.me/assets/img/pihole-wireguard-6.png&quot; alt=&quot;step 6&quot; /&gt;
&lt;/picture&gt;

&lt;ul&gt;
  &lt;li&gt;Enter the ipv4-gateway you noted down&lt;/li&gt;
&lt;/ul&gt;

&lt;picture&gt;
    &lt;source srcset=&quot;https://jasonthai.me/assets/img/pihole-wireguard-7.webp&quot; type=&quot;image/webp&quot; /&gt;
    &lt;img class=&quot;db ml-auto mr-auto&quot; src=&quot;https://jasonthai.me/assets/img/pihole-wireguard-7.png&quot; alt=&quot;step 7&quot; /&gt;
&lt;/picture&gt;

&lt;ul&gt;
  &lt;li&gt;There are a few more steps but I just choose the default settings.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;test-dns-settings&quot;&gt;Test DNS settings&lt;/h3&gt;
&lt;p&gt;Run this script&lt;/p&gt;
&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;host google.com 10.7.0.1

&lt;span class=&quot;c&quot;&gt;# Output from host google.com 10.7.0.1&lt;/span&gt;
google.com has address 172.217.0.46
google.com has IPv6 address 2607:f8b0:4005:80b::200e
google.com mail is handled by 10 aspmx.l.google.com.
google.com mail is handled by 20 alt1.aspmx.l.google.com.
google.com mail is handled by 30 alt2.aspmx.l.google.com.
google.com mail is handled by 40 alt3.aspmx.l.google.com.
google.com mail is handled by 50 alt4.aspmx.l.google.com.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Our Wireguard + Pi-hole still see google.com’s public IPs properly&lt;/p&gt;

&lt;p&gt;This time run&lt;/p&gt;
&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;host pagead2.googlesyndication.com

&lt;span class=&quot;c&quot;&gt;# Output from host pagead2.googlesyndication.com&lt;/span&gt;
pagead2.googlesyndication.com has address 0.0.0.0
pagead2.googlesyndication.com has IPv6 address ::
pagead2.googlesyndication.com is an &lt;span class=&quot;nb&quot;&gt;alias &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;pagead46.l.doubleclick.net.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Pi-hole blocked &lt;code class=&quot;highlighter-rouge&quot;&gt;pagead2.googlesyndication.com&lt;/code&gt; as the domain is in its blacklist.&lt;/p&gt;

&lt;h3 id=&quot;generate-wireguard-client-config-file&quot;&gt;Generate Wireguard Client Config File&lt;/h3&gt;
&lt;p&gt;Run &lt;code class=&quot;highlighter-rouge&quot;&gt;bash wireguard-install.sh&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;configure-wireguard-to-use-pi-hole-dns&quot;&gt;Configure Wireguard to use Pi-hole DNS&lt;/h3&gt;
&lt;p&gt;Edit your wireguard client conf file and update the DNS servers setting with Pi-hole internal address. In my case it is &lt;code class=&quot;highlighter-rouge&quot;&gt;10.7.0.1&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;test-from-browser&quot;&gt;Test From Browser&lt;/h3&gt;
&lt;p&gt;After connecting to your VPN using Wireguard client. Go to this address &lt;a href=&quot;http://pagead2.googlesyndication.com&quot;&gt;http://pagead2.googlesyndication.com&lt;/a&gt;, if everything works correctly you will see this:&lt;/p&gt;

&lt;picture&gt;
    &lt;source srcset=&quot;https://jasonthai.me/assets/img/google-syndication.webp&quot; type=&quot;image/webp&quot; /&gt;
    &lt;img class=&quot;db ml-auto mr-auto&quot; src=&quot;https://jasonthai.me/assets/img/google-syndication.png&quot; alt=&quot;google syndication&quot; /&gt;
&lt;/picture&gt;

&lt;h3 id=&quot;pi-hole-statistics&quot;&gt;Pi-hole Statistics&lt;/h3&gt;
&lt;p&gt;You can go to &lt;code class=&quot;highlighter-rouge&quot;&gt;http://pi.hole/admin&lt;/code&gt; once you are connected to the VPN and see some of Pi-hole’s stats. The result is mind-boggling. Almost half of my traffic is to serve ads.&lt;/p&gt;

&lt;picture&gt;
    &lt;source srcset=&quot;https://jasonthai.me/assets/img/pi-hole-stats.webp&quot; type=&quot;image/webp&quot; /&gt;
    &lt;img class=&quot;db ml-auto mr-auto&quot; src=&quot;https://jasonthai.me/assets/img/pi-hole-stats.png&quot; alt=&quot;Pi-hole stats&quot; /&gt;
&lt;/picture&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Pi-hole is a good solution to fight against ads on the internet. You should give it a try. That said not all ads are bad. Some creators are reliant on ads as their source of income. If you have someone you support, consider whitelisting the ads for the good cause.&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/Nyr/wireguard-install&quot;&gt;https://github.com/Nyr/wireguard-install&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://pi-hole.net/&quot;&gt;https://pi-hole.net/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Jason Thai</name></author><category term="tech" /><category term="en" /><summary type="html">WireGuard® is an extremely simple yet fast and modern VPN that utilizes state-of-the-art cryptography. It aims to be faster, simpler, leaner, and more useful than IPsec, while avoiding the massive headache. It intends to be considerably more performant than OpenVPN. WireGuard is designed as a general purpose VPN for running on embedded interfaces and super computers alike, fit for many different circumstances. Initially released for the Linux kernel, it is now cross-platform (Windows, macOS, BSD, iOS, Android) and widely deployable. It is currently under heavy development, but already it might be regarded as the most secure, easiest to use, and simplest VPN solution in the industry. https://www.wireguard.com Introduction Follow up for my post How to host OpenVPN and Pi-hole on Ubuntu 18.04 VPS. This is a guide to set up wireguard + pi-hole for your own private ad blocking VPN. Installation Wireguard Setup Run these scripts: wget https://git.io/wireguard -O wireguard-install.sh &amp;amp;&amp;amp; bash wireguard-install.sh Follow this setup: Welcome to this WireGuard road warrior installer! I need to ask you a few questions before starting setup. You can use the default options and just press enter if you are ok with them. What IPv4 address should the WireGuard server use? 1) Your IPv4 address should show up here 2) other local IP IPv4 address [1]: 1 What port do you want WireGuard listening to? Port [51820]: 51820 Tell me a name for the first client. Client name [client]: client Which DNS do you want to use for this client? 1) Current system resolvers 2) 1.1.1.1 3) Google 4) OpenDNS 5) NTT 6) AdGuard DNS [1]: 2 We are ready to set up your WireGuard server now. Press any key to continue... Start Wireguard Wireguard should start automatically after you ran the script. If not you can check by systemctl status wg-quick@wg0.service Restart Wireguard services: systemctl restart wg-quick@wg0.service Pi-hole Setup Note down Wireguard’s IP: ip a show dev wg0 10.7.0.1/24 // note this address Note down your default gateway IP address: ip r | grep default default via XXX.XXX.XXX.XXX dev eth0 onlink // note this address Run this script: curl -sSL https://install.pi-hole.net | bash Follow the instruction to set up pi-hole: Installing dependencies The following step is important, make sure to select wg0 as the interface Choose the DNS provider Pi-hole will use. Choose the protocols available to you This following step is important, make sure to choose no so we can assign our internal address which is 10.7.0.1. Enter 10.7.0.1/24. This is the static address VPN will use to talk to Pi-hole Enter the ipv4-gateway you noted down There are a few more steps but I just choose the default settings. Test DNS settings Run this script host google.com 10.7.0.1 # Output from host google.com 10.7.0.1 google.com has address 172.217.0.46 google.com has IPv6 address 2607:f8b0:4005:80b::200e google.com mail is handled by 10 aspmx.l.google.com. google.com mail is handled by 20 alt1.aspmx.l.google.com. google.com mail is handled by 30 alt2.aspmx.l.google.com. google.com mail is handled by 40 alt3.aspmx.l.google.com. google.com mail is handled by 50 alt4.aspmx.l.google.com. Our Wireguard + Pi-hole still see google.com’s public IPs properly This time run host pagead2.googlesyndication.com # Output from host pagead2.googlesyndication.com pagead2.googlesyndication.com has address 0.0.0.0 pagead2.googlesyndication.com has IPv6 address :: pagead2.googlesyndication.com is an alias for pagead46.l.doubleclick.net. Pi-hole blocked pagead2.googlesyndication.com as the domain is in its blacklist. Generate Wireguard Client Config File Run bash wireguard-install.sh Configure Wireguard to use Pi-hole DNS Edit your wireguard client conf file and update the DNS servers setting with Pi-hole internal address. In my case it is 10.7.0.1 Test From Browser After connecting to your VPN using Wireguard client. Go to this address http://pagead2.googlesyndication.com, if everything works correctly you will see this: Pi-hole Statistics You can go to http://pi.hole/admin once you are connected to the VPN and see some of Pi-hole’s stats. The result is mind-boggling. Almost half of my traffic is to serve ads. Conclusion Pi-hole is a good solution to fight against ads on the internet. You should give it a try. That said not all ads are bad. Some creators are reliant on ads as their source of income. If you have someone you support, consider whitelisting the ads for the good cause. References https://github.com/Nyr/wireguard-install https://pi-hole.net/</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jasonthai.me/assets/img/openvpn-pihole.png" /><media:content medium="image" url="https://jasonthai.me/assets/img/openvpn-pihole.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Donate Compute Power to Folding@Home to Find Cures For Covid-19</title><link href="https://jasonthai.me/blog/2020/03/14/donate-compute-power-to-foldinghome-to-cures-for-covid-19/" rel="alternate" type="text/html" title="Donate Compute Power to Folding@Home to Find Cures For Covid-19" /><published>2020-03-14T00:00:00+00:00</published><updated>2020-03-14T00:00:00+00:00</updated><id>https://jasonthai.me/blog/2020/03/14/donate-compute-power-to-foldinghome-to-cures-for-covid-19</id><content type="html" xml:base="https://jasonthai.me/blog/2020/03/14/donate-compute-power-to-foldinghome-to-cures-for-covid-19/">&lt;p&gt;If you have not heard of Folding@Home, it is basically a software you can download to your computer and uses part of the computer power to help scientists run models and find cures for various diseases.&lt;/p&gt;

&lt;p&gt;I suggest you take a look at their website to learn more: &lt;a href=&quot;https://foldingathome.org/&quot;&gt;https://foldingathome.org/&lt;/a&gt;. Currently they are looking for more compute power to combat against Covid-19(20). Please help out however you can.&lt;/p&gt;</content><author><name>Jason Thai</name></author><category term="blog" /><category term="en" /><summary type="html">If you have not heard of Folding@Home, it is basically a software you can download to your computer and uses part of the computer power to help scientists run models and find cures for various diseases. I suggest you take a look at their website to learn more: https://foldingathome.org/. Currently they are looking for more compute power to combat against Covid-19(20). Please help out however you can.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jasonthai.me/assets/img/foldingathome.png" /><media:content medium="image" url="https://jasonthai.me/assets/img/foldingathome.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Some Notes on Apache Spark Memory Management</title><link href="https://jasonthai.me/blog/2020/02/27/some-notes-on-apache-spark-memory-management/" rel="alternate" type="text/html" title="Some Notes on Apache Spark Memory Management" /><published>2020-02-27T00:00:00+00:00</published><updated>2020-02-27T00:00:00+00:00</updated><id>https://jasonthai.me/blog/2020/02/27/some-notes-on-apache-spark-memory-management</id><content type="html" xml:base="https://jasonthai.me/blog/2020/02/27/some-notes-on-apache-spark-memory-management/">&lt;h2 id=&quot;important-configurations&quot;&gt;Important configurations:&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.executor.memory&lt;/span&gt; – Size of memory to use for each executor that runs the task.&lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.executor.cores&lt;/span&gt; – Number of virtual cores.&lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.driver.memory&lt;/span&gt; – Size of memory to use for the driver.&lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.driver.cores&lt;/span&gt; – Number of virtual cores to use for the driver.&lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.executor.instances&lt;/span&gt; – Number of executors. Set this parameter unless spark.dynamicAllocation.enabled is set to true.&lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.default.parallelism&lt;/span&gt; – Default number of partitions in resilient distributed datasets (RDDs) returned by transformations like join, reduceByKey, and parallelize when no partition number is set by the user&lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.sql.execution.arrow.enabled&lt;/span&gt; - Enable optimization for panda dataframe&lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.files.ignoreCorruptFiles&lt;/span&gt; - Ignore corrupt files&lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.sql.files.ignoreCorruptFiles&lt;/span&gt; - Ignore corrupt files&lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.executor.extraJavaOptions&lt;/span&gt; - Other Java options like garbage collection for executors&lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.driver.extraJavaOptions&lt;/span&gt; - Other Java options like garbage collection for drivers&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;sample-calculations&quot;&gt;Sample Calculations:&lt;/h2&gt;

&lt;p&gt;Consider an EMR cluster with 1 master - 25 slaves running c5.18xlarge instance. Each instance comes with 72vCPU, 144 GiB Memory.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.executor.cores&lt;/span&gt; = number of virtual cores per executor. Recommendation is 5
    &lt;blockquote&gt;
      &lt;p&gt;spark.excutor.cores = 5&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;Number of executors per instance = (total number of virtual cores per instance - 1)/ spark.executors.cores&lt;br /&gt;
    &lt;blockquote&gt;
      &lt;p&gt;Number of executors per instance = (72 - 1) / 5 = 14&lt;/p&gt;
    &lt;/blockquote&gt;

    &lt;p&gt;Total executor memory = total RAM per instance / number of executors per instance&lt;br /&gt;&lt;/p&gt;
    &lt;blockquote&gt;
      &lt;p&gt;Total executor memory = 144 / 14 = 10 (round down)&lt;/p&gt;
    &lt;/blockquote&gt;

    &lt;p&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.executors.memory&lt;/span&gt; = total executor memory * 0.9&lt;/p&gt;
    &lt;blockquote&gt;
      &lt;p&gt;spark.executors.memory = 10 * 0.9 = 9g&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.executor.memoryOverhead&lt;/span&gt; = total executor memory * 0.10
    &lt;blockquote&gt;
      &lt;p&gt;spark.excutor.memoryOverhead = 10 * 0.1 = 1g&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.driver.memory&lt;/span&gt; = spark.executors.memory
    &lt;blockquote&gt;
      &lt;p&gt;spark.driver.memory = 9g&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.driver.cores&lt;/span&gt;= spark.executors.cores
    &lt;blockquote&gt;
      &lt;p&gt;spark.driver.cores = 5&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.executor.instances&lt;/span&gt; = (number of executors per instance * number of core instances) minus 1 for the driver
    &lt;blockquote&gt;
      &lt;p&gt;spark.executor.instances = 14 * 25 - 1 = 349&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.default.parallelism&lt;/span&gt; = spark.executor.instances * spark.executors.cores * 2
    &lt;blockquote&gt;
      &lt;p&gt;spark.default.parallelism = 349 * 5 * 2 = 3490&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.executor.extraJavaOptions&lt;/span&gt;
    &lt;blockquote&gt;
      &lt;p&gt;spark.executor.extraJavaOptions = -XX:+UseG1GC -XX:+UnlockDiagnosticVMOptions -XX:+G1SummarizeConcMark -XX:InitiatingHeapOccupancyPercent=35 -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:OnOutOfMemoryError=’kill -9 %p’&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;span style=&quot;color: darkred&quot;&gt;spark.driver.extraJavaOptions&lt;/span&gt;
    &lt;blockquote&gt;
      &lt;p&gt;spark.executor.extraJavaOptions = -XX:+UseG1GC -XX:+UnlockDiagnosticVMOptions -XX:+G1SummarizeConcMark -XX:InitiatingHeapOccupancyPercent=35 -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:OnOutOfMemoryError=’kill -9 %p’&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;sources&quot;&gt;Sources:&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://aws.amazon.com/blogs/big-data/best-practices-for-successfully-managing-memory-for-apache-spark-applications-on-amazon-emr/&quot;&gt;https://aws.amazon.com/blogs/big-data/best-practices-for-successfully-managing-memory-for-apache-spark-applications-on-amazon-emr/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://spark.apache.org/docs/latest/sql-pyspark-pandas-with-arrow.html&quot;&gt;https://spark.apache.org/docs/latest/sql-pyspark-pandas-with-arrow.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Jason Thai</name></author><category term="tech" /><category term="en" /><summary type="html">Important configurations: spark.executor.memory – Size of memory to use for each executor that runs the task. spark.executor.cores – Number of virtual cores. spark.driver.memory – Size of memory to use for the driver. spark.driver.cores – Number of virtual cores to use for the driver. spark.executor.instances – Number of executors. Set this parameter unless spark.dynamicAllocation.enabled is set to true. spark.default.parallelism – Default number of partitions in resilient distributed datasets (RDDs) returned by transformations like join, reduceByKey, and parallelize when no partition number is set by the user spark.sql.execution.arrow.enabled - Enable optimization for panda dataframe spark.files.ignoreCorruptFiles - Ignore corrupt files spark.sql.files.ignoreCorruptFiles - Ignore corrupt files spark.executor.extraJavaOptions - Other Java options like garbage collection for executors spark.driver.extraJavaOptions - Other Java options like garbage collection for drivers Sample Calculations: Consider an EMR cluster with 1 master - 25 slaves running c5.18xlarge instance. Each instance comes with 72vCPU, 144 GiB Memory. spark.executor.cores = number of virtual cores per executor. Recommendation is 5 spark.excutor.cores = 5 Number of executors per instance = (total number of virtual cores per instance - 1)/ spark.executors.cores Number of executors per instance = (72 - 1) / 5 = 14 Total executor memory = total RAM per instance / number of executors per instance Total executor memory = 144 / 14 = 10 (round down) spark.executors.memory = total executor memory * 0.9 spark.executors.memory = 10 * 0.9 = 9g spark.executor.memoryOverhead = total executor memory * 0.10 spark.excutor.memoryOverhead = 10 * 0.1 = 1g spark.driver.memory = spark.executors.memory spark.driver.memory = 9g spark.driver.cores= spark.executors.cores spark.driver.cores = 5 spark.executor.instances = (number of executors per instance * number of core instances) minus 1 for the driver spark.executor.instances = 14 * 25 - 1 = 349 spark.default.parallelism = spark.executor.instances * spark.executors.cores * 2 spark.default.parallelism = 349 * 5 * 2 = 3490 spark.executor.extraJavaOptions spark.executor.extraJavaOptions = -XX:+UseG1GC -XX:+UnlockDiagnosticVMOptions -XX:+G1SummarizeConcMark -XX:InitiatingHeapOccupancyPercent=35 -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:OnOutOfMemoryError=’kill -9 %p’ spark.driver.extraJavaOptions spark.executor.extraJavaOptions = -XX:+UseG1GC -XX:+UnlockDiagnosticVMOptions -XX:+G1SummarizeConcMark -XX:InitiatingHeapOccupancyPercent=35 -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:OnOutOfMemoryError=’kill -9 %p’ Sources: https://aws.amazon.com/blogs/big-data/best-practices-for-successfully-managing-memory-for-apache-spark-applications-on-amazon-emr/ https://spark.apache.org/docs/latest/sql-pyspark-pandas-with-arrow.html</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jasonthai.me/assets/img/spark.png" /><media:content medium="image" url="https://jasonthai.me/assets/img/spark.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Better SSH Keys Management with AuthorizedKeysCommand</title><link href="https://jasonthai.me/blog/2020/02/19/better-ssh-keys-management-with-authorizedkeyscommand/" rel="alternate" type="text/html" title="Better SSH Keys Management with AuthorizedKeysCommand" /><published>2020-02-19T00:00:00+00:00</published><updated>2020-02-19T00:00:00+00:00</updated><id>https://jasonthai.me/blog/2020/02/19/better-ssh-keys-management-with-authorizedkeyscommand</id><content type="html" xml:base="https://jasonthai.me/blog/2020/02/19/better-ssh-keys-management-with-authorizedkeyscommand/">&lt;p&gt;I usually use authorized_key files to store SSH public keys in order to access my servers . However once I start to have multiple servers, I realize manually managing SSH keys is nightmare.&lt;/p&gt;

&lt;p&gt;Recently I found out a better way to manage these SSH keys
In /etc/ssh/sshd_config file there are 2 configurations:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;AuthorizedKeysCommand /keys.sh
AuthorizedKeysCommandUser nobody
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can use &lt;strong&gt;AuthorizedKeysCommand&lt;/strong&gt; to point to an script that returns all the SSH keys. In this case, my script is:&lt;/p&gt;
&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
curl https://raw.githubusercontent.com/jasontthai/keys/master/&lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Name this file &lt;code class=&quot;highlighter-rouge&quot;&gt;key.sh&lt;/code&gt; and make it executable: &lt;code class=&quot;highlighter-rouge&quot;&gt;chmod a+x /keys.sh&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;The public keys are stored in a Github repo which can be updated any time. The structure of the repo is this:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;keys/
├── user1
├── user2
├── user3
└── user4
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When I login with  user1, the server will get user1’s public keys from Github and validates it agaisnt user1’s private key.&lt;/p&gt;

&lt;p&gt;There are a few problems with this approach:  I rely on an external service to retrieve the public keys. If Github goes offline, I will be unable to login to my servers at all. This also adds latency to the login step as we need to retrieve the keys over the internet. So I should think about some caching mechanism in case this happens.&lt;/p&gt;</content><author><name>Jason Thai</name></author><category term="tech" /><category term="en" /><summary type="html">I usually use authorized_key files to store SSH public keys in order to access my servers . However once I start to have multiple servers, I realize manually managing SSH keys is nightmare. Recently I found out a better way to manage these SSH keys In /etc/ssh/sshd_config file there are 2 configurations: AuthorizedKeysCommand /keys.sh AuthorizedKeysCommandUser nobody We can use AuthorizedKeysCommand to point to an script that returns all the SSH keys. In this case, my script is: #!/bin/bash curl https://raw.githubusercontent.com/jasontthai/keys/master/$1 Name this file key.sh and make it executable: chmod a+x /keys.sh The public keys are stored in a Github repo which can be updated any time. The structure of the repo is this: keys/ ├── user1 ├── user2 ├── user3 └── user4 When I login with user1, the server will get user1’s public keys from Github and validates it agaisnt user1’s private key. There are a few problems with this approach: I rely on an external service to retrieve the public keys. If Github goes offline, I will be unable to login to my servers at all. This also adds latency to the login step as we need to retrieve the keys over the internet. So I should think about some caching mechanism in case this happens.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jasonthai.me/assets/img/ssh.jpg" /><media:content medium="image" url="https://jasonthai.me/assets/img/ssh.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Setup Shell Script for Linux-based Servers</title><link href="https://jasonthai.me/blog/2020/02/12/setup-shell-script-for-linux-based-servers/" rel="alternate" type="text/html" title="Setup Shell Script for Linux-based Servers" /><published>2020-02-12T00:00:00+00:00</published><updated>2020-02-12T00:00:00+00:00</updated><id>https://jasonthai.me/blog/2020/02/12/setup-shell-script-for-linux-based-servers</id><content type="html" xml:base="https://jasonthai.me/blog/2020/02/12/setup-shell-script-for-linux-based-servers/">&lt;p&gt;Since I have a few Linux servers that are running RHEL, Debian or Ubuntu OS, I want to have an automatic and convenient way to quickly set up and get them running.  Specifically I want to do a the following things for a fresh server:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Upgrade the server’s packages to the latest version&lt;/li&gt;
  &lt;li&gt;Install essential packages such as: fail2ban, ufw, htop, apache2, docker, etc.&lt;/li&gt;
  &lt;li&gt;Create new user with sudo access&lt;/li&gt;
  &lt;li&gt;Disable root login and password authentication in favor of SSH keys&lt;/li&gt;
  &lt;li&gt;Ability to install other packages if required&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;With that in mind, I created a simple setup script which you can find here: &lt;a href=&quot;https://github.com/jasontthai/shell-scripts&quot;&gt;https://github.com/jasontthai/shell-scripts&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;running-the-script&quot;&gt;Running the Script&lt;/h3&gt;
&lt;p&gt;To run the script manually with prompt so you can decide what the script does:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -L json.id/setup.sh | sudo bash
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;To run the script in automatic mode without prompt except for adding new user:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -L json.id/setup.sh | sudo bash -s -- -a
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;example-of-output&quot;&gt;Example of output&lt;/h3&gt;
&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-sL&lt;/span&gt; json.id/setup.sh | &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;bash
&lt;span class=&quot;c&quot;&gt;# ## ## ## ## ## ## ## ## ## ## ## ## #&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#           VPS Setup Script          #&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ## ## ## ## ## ## ## ## ## ## ## ## #&lt;/span&gt;

Wed 12 Feb 2020 03:56:01 PM PST
Updating system...

Installing Basic Packages: &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;ufw fail2ban htop curl apache2

Add Sudo User? &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;y/N]: y
Disable Root Login? &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;y/N]: y
Disable Password Authentication? &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;y/N]: y
Install Docker? &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;y/N]: y
Install Docker Compose? &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;y/N]: y
Enter your TIMEZONE &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Empty to skip]:
Enter any other packages to be installed &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Empty to skip]:

Setting &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;user...
Username: testuser
Password:

Adding SSH Keys
Enter SSH Key &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Empty to skip]:

Disabling Root Login...

Disabling Password Authentication...

Docker Installed. Added testuser to docker group

Docker Compose Installed.

Finished setup script.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;or to view help&lt;/p&gt;
&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-sL&lt;/span&gt; json.id/setup.sh | &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;bash &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ## ## ## ## ## ## ## ## ## ## ## ## #&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#           VPS Setup Script          #&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ## ## ## ## ## ## ## ## ## ## ## ## #&lt;/span&gt;

Wed 12 Feb 2020 04:04:07 PM PST

Usage: ./setup.sh &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-mh&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
       curl &lt;span class=&quot;nt&quot;&gt;-sL&lt;/span&gt; json.id/setup.sh | &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;bash
       curl &lt;span class=&quot;nt&quot;&gt;-sL&lt;/span&gt; json.id/setup.sh | &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;bash &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;ah&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

Flags:
       &lt;span class=&quot;nt&quot;&gt;-a&lt;/span&gt; : run setup script automatically
       &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt; : prints this lovely message, &lt;span class=&quot;k&quot;&gt;then &lt;/span&gt;exits
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>Jason Thai</name></author><category term="tech" /><category term="en" /><summary type="html">Since I have a few Linux servers that are running RHEL, Debian or Ubuntu OS, I want to have an automatic and convenient way to quickly set up and get them running. Specifically I want to do a the following things for a fresh server: Upgrade the server’s packages to the latest version Install essential packages such as: fail2ban, ufw, htop, apache2, docker, etc. Create new user with sudo access Disable root login and password authentication in favor of SSH keys Ability to install other packages if required With that in mind, I created a simple setup script which you can find here: https://github.com/jasontthai/shell-scripts Running the Script To run the script manually with prompt so you can decide what the script does: curl -L json.id/setup.sh | sudo bash To run the script in automatic mode without prompt except for adding new user: curl -L json.id/setup.sh | sudo bash -s -- -a Example of output curl -sL json.id/setup.sh | sudo bash # ## ## ## ## ## ## ## ## ## ## ## ## # # VPS Setup Script # # ## ## ## ## ## ## ## ## ## ## ## ## # Wed 12 Feb 2020 03:56:01 PM PST Updating system... Installing Basic Packages: sudo ufw fail2ban htop curl apache2 Add Sudo User? [y/N]: y Disable Root Login? [y/N]: y Disable Password Authentication? [y/N]: y Install Docker? [y/N]: y Install Docker Compose? [y/N]: y Enter your TIMEZONE [Empty to skip]: Enter any other packages to be installed [Empty to skip]: Setting sudo user... Username: testuser Password: Adding SSH Keys Enter SSH Key [Empty to skip]: Disabling Root Login... Disabling Password Authentication... Docker Installed. Added testuser to docker group Docker Compose Installed. Finished setup script. or to view help curl -sL json.id/setup.sh | sudo bash -s -- -h # ## ## ## ## ## ## ## ## ## ## ## ## # # VPS Setup Script # # ## ## ## ## ## ## ## ## ## ## ## ## # Wed 12 Feb 2020 04:04:07 PM PST Usage: ./setup.sh [-mh] curl -sL json.id/setup.sh | sudo bash curl -sL json.id/setup.sh | sudo bash -s --{ah} Flags: -a : run setup script automatically -h : prints this lovely message, then exits</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jasonthai.me/assets/img/scripts.png" /><media:content medium="image" url="https://jasonthai.me/assets/img/scripts.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Free Public xBrowserSync Service</title><link href="https://jasonthai.me/blog/2020/01/03/free-public-xbrowsersync-service/" rel="alternate" type="text/html" title="Free Public xBrowserSync Service" /><published>2020-01-03T00:00:00+00:00</published><updated>2020-01-03T00:00:00+00:00</updated><id>https://jasonthai.me/blog/2020/01/03/free-public-xbrowsersync-service</id><content type="html" xml:base="https://jasonthai.me/blog/2020/01/03/free-public-xbrowsersync-service/">&lt;p&gt;TL;DR: My xbrowsersync service API can be accessed through: &lt;a href=&quot;https://xbrowsersync.jasonthai.me&quot;&gt;https://xbrowsersync.jasonthai.me&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Before using xBrowserSync, I do not have a good way of consolidating all my bookmarks. xBrowserSync helps me sync all my bookmarks across different browsers like Chrome, Firefox, Brave, etc.&lt;/p&gt;

&lt;p&gt;After you have downloaded the &lt;a href=&quot;https://www.xbrowsersync.org/#download&quot;&gt;extension for your browser&lt;/a&gt;, you can either use the default provided xbrowsersync service or you can update to my service in the setting:&lt;/p&gt;

&lt;picture&gt;
    &lt;source srcset=&quot;https://jasonthai.me/assets/img/xbrowsersync-setting.webp&quot; type=&quot;image/webp&quot; /&gt;
    &lt;img class=&quot;db ml-auto mr-auto&quot; src=&quot;https://jasonthai.me/assets/img/xbrowsersync-setting.jpeg&quot; alt=&quot;xbrowsersync setting&quot; /&gt;
&lt;/picture&gt;

&lt;p&gt;From &lt;a href=&quot;https://xbrowsersync.org&quot;&gt;https://xbrowsersync.org&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;

  &lt;p&gt;xBrowserSync is a free and open-source alternative to browser syncing tools offered by companies like Google, Firefox, Opera and others. The project was born out of a concern for the over-reliance on services provided by big tech, who collect as much personal data as they can and have demonstrated that they do not respect their user’s privacy . Now, with the proliferation of open-source code and projects it’s easier than ever to create tools and services that allow users to take back control of their data!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;

  &lt;p&gt;xBrowserSync respects your privacy and gives you complete anonymity. No sign up is required and no personal data is ever collected. To start syncing simply download xBrowserSync for your desktop browser or mobile platform, enter an encryption password and click Create New Sync! You’ll receive an anonymous sync ID which identifies your data and can be used to access your data on other browsers and devices.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;

  &lt;p&gt;xBrowserSync does not only sync but also enhances your productivity by enriching your native browser bookmarks with the addition of descriptions and tags, and an intuitive search interface enables you to find, modify and share bookmarks quickly and easily. xBrowserSync even adds descriptions and tags to new bookmarks for you automatically. And don’t ever worry about losing your data thanks to the included back up and restore functionality.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;

  &lt;p&gt;The xBrowserSync desktop browser web extension syncs your browser data between desktop browsers. It works with the browser’s native bookmarking features so you can keep using the native tools whilst always staying in sync. If you like to organise your bookmarks into folders don’t worry, xBrowserSync respects your bookmark hierarchy and syncs it across your browsers.&lt;/p&gt;
&lt;/blockquote&gt;</content><author><name>Jason Thai</name></author><category term="tech" /><category term="en" /><summary type="html">TL;DR: My xbrowsersync service API can be accessed through: https://xbrowsersync.jasonthai.me Before using xBrowserSync, I do not have a good way of consolidating all my bookmarks. xBrowserSync helps me sync all my bookmarks across different browsers like Chrome, Firefox, Brave, etc. After you have downloaded the extension for your browser, you can either use the default provided xbrowsersync service or you can update to my service in the setting: From https://xbrowsersync.org: xBrowserSync is a free and open-source alternative to browser syncing tools offered by companies like Google, Firefox, Opera and others. The project was born out of a concern for the over-reliance on services provided by big tech, who collect as much personal data as they can and have demonstrated that they do not respect their user’s privacy . Now, with the proliferation of open-source code and projects it’s easier than ever to create tools and services that allow users to take back control of their data! xBrowserSync respects your privacy and gives you complete anonymity. No sign up is required and no personal data is ever collected. To start syncing simply download xBrowserSync for your desktop browser or mobile platform, enter an encryption password and click Create New Sync! You’ll receive an anonymous sync ID which identifies your data and can be used to access your data on other browsers and devices. xBrowserSync does not only sync but also enhances your productivity by enriching your native browser bookmarks with the addition of descriptions and tags, and an intuitive search interface enables you to find, modify and share bookmarks quickly and easily. xBrowserSync even adds descriptions and tags to new bookmarks for you automatically. And don’t ever worry about losing your data thanks to the included back up and restore functionality. The xBrowserSync desktop browser web extension syncs your browser data between desktop browsers. It works with the browser’s native bookmarking features so you can keep using the native tools whilst always staying in sync. If you like to organise your bookmarks into folders don’t worry, xBrowserSync respects your bookmark hierarchy and syncs it across your browsers.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jasonthai.me/assets/img/xbrowsersync.png" /><media:content medium="image" url="https://jasonthai.me/assets/img/xbrowsersync.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">December List of Selfhosted Apps</title><link href="https://jasonthai.me/blog/2019/12/26/december-list-of-selfhosted-apps/" rel="alternate" type="text/html" title="December List of Selfhosted Apps" /><published>2019-12-26T00:00:00+00:00</published><updated>2019-12-26T00:00:00+00:00</updated><id>https://jasonthai.me/blog/2019/12/26/december-list-of-selfhosted-apps</id><content type="html" xml:base="https://jasonthai.me/blog/2019/12/26/december-list-of-selfhosted-apps/">&lt;p&gt;This is probably the last post of December 2019. I wish everyone has had a good year so far and an exciting 2020.&lt;/p&gt;

&lt;p&gt;I have been playing around with selfhosting some more and here is the list of apps I am currently hosting:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.portainer.io&quot;&gt;Portainer&lt;/a&gt; - Docker management system&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://heimdall.site&quot;&gt;Heimdall&lt;/a&gt; - Application dashboard&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://plex.tv&quot;&gt;Plex&lt;/a&gt; - Media management system&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://tautulli.com&quot;&gt;Tautulli&lt;/a&gt; - Plex media server monitoring&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://ombi.io&quot;&gt;Ombi&lt;/a&gt; - Request movies &amp;amp; TV for plex users&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://nextcloud.com&quot;&gt;Nextcloud&lt;/a&gt; - Productivity platform and more&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://bitwarden.com&quot;&gt;Bitwarden&lt;/a&gt; - Password manager&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Current server providers I am using:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://terrahost.no&quot;&gt;TerraHost&lt;/a&gt; - Dedicated server for media streaming&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://hetzner.com&quot;&gt;Hetzner&lt;/a&gt; - Dedicated server for media streaming&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://smarthost.com&quot;&gt;Smarthost&lt;/a&gt; - VPS for selfhosted apps&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://hosthatch.com&quot;&gt;Hosthatch&lt;/a&gt; - Storage VPS&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://ionswitch.com&quot;&gt;IonSwitch&lt;/a&gt; - VPS for my blog&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://buyvm.net&quot;&gt;Buyvm&lt;/a&gt; - VPS for VPN&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://php-friends.de&quot;&gt;PHP-Friends&lt;/a&gt; - VPS for selfhosted apps&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://letbox.com&quot;&gt;Letbox&lt;/a&gt; - Storage VPS&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://inceptionhosting.com&quot;&gt;InceptionHosting&lt;/a&gt; - VPS for VPN&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://hostsolutions.ro&quot;&gt;Hostsolutions&lt;/a&gt; - Storage VPS&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Tools I am using to monitor servers:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://hetrixtools.com&quot;&gt;HetrixTools&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/BotoX/ServerStatus&quot;&gt;ServerStatus&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Server forums I am checking:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://lowendtalk.com&quot;&gt;LowendTalk&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://talk.lowendspirit.com&quot;&gt;LowendSpirit&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Feel free to contact me if you are interested in knowing more about these selfhosted apps. Cheers!&lt;/p&gt;</content><author><name>Jason Thai</name></author><category term="tech" /><category term="en" /><summary type="html">This is probably the last post of December 2019. I wish everyone has had a good year so far and an exciting 2020. I have been playing around with selfhosting some more and here is the list of apps I am currently hosting: Portainer - Docker management system Heimdall - Application dashboard Plex - Media management system Tautulli - Plex media server monitoring Ombi - Request movies &amp;amp; TV for plex users Nextcloud - Productivity platform and more Bitwarden - Password manager Current server providers I am using: TerraHost - Dedicated server for media streaming Hetzner - Dedicated server for media streaming Smarthost - VPS for selfhosted apps Hosthatch - Storage VPS IonSwitch - VPS for my blog Buyvm - VPS for VPN PHP-Friends - VPS for selfhosted apps Letbox - Storage VPS InceptionHosting - VPS for VPN Hostsolutions - Storage VPS Tools I am using to monitor servers: HetrixTools ServerStatus Server forums I am checking: LowendTalk LowendSpirit Feel free to contact me if you are interested in knowing more about these selfhosted apps. Cheers!</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jasonthai.me/assets/img/cloud-server.png" /><media:content medium="image" url="https://jasonthai.me/assets/img/cloud-server.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Deploy Nextcloud With Docker Compose in Ubuntu 18.04</title><link href="https://jasonthai.me/blog/2019/11/03/deploy-nextcloud-with-docker-compose/" rel="alternate" type="text/html" title="Deploy Nextcloud With Docker Compose in Ubuntu 18.04" /><published>2019-11-03T00:00:00+00:00</published><updated>2019-11-03T00:00:00+00:00</updated><id>https://jasonthai.me/blog/2019/11/03/deploy-nextcloud-with-docker-compose</id><content type="html" xml:base="https://jasonthai.me/blog/2019/11/03/deploy-nextcloud-with-docker-compose/">&lt;p&gt;In one of the previous posts, I mentioned using &lt;a href=&quot;https://nextcloud.com/&quot;&gt;Nextcloud&lt;/a&gt; as a self-hosted cloud platform. This post goes into details how I set up my instance.&lt;/p&gt;

&lt;h2 id=&quot;install-docker-and-docker-compose&quot;&gt;Install Docker and Docker-Compose&lt;/h2&gt;
&lt;p&gt;To install docker, run:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To install docker-compose, run:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;docker-composeyml&quot;&gt;docker-compose.yml&lt;/h2&gt;
&lt;p&gt;Create this &lt;code class=&quot;highlighter-rouge&quot;&gt;docker-compose.yml&lt;/code&gt; with following contents:&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;3'&lt;/span&gt;

&lt;span class=&quot;na&quot;&gt;services&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;db&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mariadb&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;--transaction-isolation=READ-COMMITTED --binlog-format=ROW&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;restart&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;always&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/opt/nextcloud-db:/var/lib/mysql&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;MYSQL_ROOT_PASSWORD=ENTER MYSQL PASSWORD&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;MYSQL_PASSWORD=ENTER MYSQL PASSWORD&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;MYSQL_DATABASE=nextcloud&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;MYSQL_USER=nextcloud&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;redis&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;redis:alpine&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;restart&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;always&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nextcloud:apache&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;8080:80&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;REDIS_HOST=redis&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;depends_on&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;db&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;redis&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/opt/nextcloud-data:/var/www/html&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;restart&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;always&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;cron&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nextcloud:apache&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;restart&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;always&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/opt/nextcloud-data:/var/www/html&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;entrypoint&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/cron.sh&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;depends_on&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;db&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;redis&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Run &lt;code class=&quot;highlighter-rouge&quot;&gt;docker-compose -f docker-compose.yml up -d&lt;/code&gt; to start all necessary containers.&lt;/p&gt;

&lt;h2 id=&quot;setting-up&quot;&gt;Setting Up&lt;/h2&gt;

&lt;p&gt;Browse to &lt;code class=&quot;highlighter-rouge&quot;&gt;http://localhost:8080&lt;/code&gt; and you’ll see a set up page like this:&lt;/p&gt;

&lt;picture&gt;
    &lt;source srcset=&quot;https://jasonthai.me/assets/img/nextcloud-setup.webp&quot; type=&quot;image/webp&quot; /&gt;
    &lt;img class=&quot;db ml-auto mr-auto&quot; src=&quot;https://jasonthai.me/assets/img/nextcloud-setup.png&quot; alt=&quot;Setup&quot; /&gt;
&lt;/picture&gt;

&lt;p&gt;Fill in the fills as the following:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Database user: nextcloud&lt;/li&gt;
  &lt;li&gt;Database password: Enter your password in &lt;code class=&quot;highlighter-rouge&quot;&gt;docker-compose.yml&lt;/code&gt; file&lt;/li&gt;
  &lt;li&gt;Database name: nextcloud&lt;/li&gt;
  &lt;li&gt;Database host: db&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;After setting up nextcloud, you will see something like:&lt;/p&gt;

&lt;picture&gt;
    &lt;source srcset=&quot;https://jasonthai.me/assets/img/nextcloud.webp&quot; type=&quot;image/webp&quot; /&gt;
    &lt;img class=&quot;db ml-auto mr-auto&quot; src=&quot;https://jasonthai.me/assets/img/nextcloud.jpeg&quot; alt=&quot;Nextcloud&quot; /&gt;
&lt;/picture&gt;

&lt;h2 id=&quot;modify-overwrite-protocal&quot;&gt;Modify Overwrite Protocal&lt;/h2&gt;
&lt;p&gt;Modify &lt;code class=&quot;highlighter-rouge&quot;&gt;/opt/nextcloud-data/config/config.php&lt;/code&gt; and add:&lt;/p&gt;
&lt;div class=&quot;language-conf highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s1&quot;&gt;'overwriteprotocol'&lt;/span&gt; =&amp;gt; &lt;span class=&quot;s1&quot;&gt;'https'&lt;/span&gt;,
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;modify-upload-max-filesize&quot;&gt;Modify Upload Max Filesize&lt;/h2&gt;
&lt;p&gt;By default, Nextcloud only allows uploading file up to 2MB which is not very useful. We can modify the max filesize by adding &lt;code class=&quot;highlighter-rouge&quot;&gt;/opt/nextcloud-data/.htaccess&lt;/code&gt; with following:&lt;/p&gt;
&lt;div class=&quot;language-conf highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;&lt;span class=&quot;n&quot;&gt;IfModule&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mod_php7&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&amp;gt;
...
&lt;span class=&quot;n&quot;&gt;php_value&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;upload_max_filesize&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;G&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;php_value&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;post_max_size&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;G&lt;/span&gt;
&amp;lt;/&lt;span class=&quot;n&quot;&gt;IfModule&lt;/span&gt;&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>Jason Thai</name></author><category term="tech" /><category term="en" /><summary type="html">In one of the previous posts, I mentioned using Nextcloud as a self-hosted cloud platform. This post goes into details how I set up my instance. Install Docker and Docker-Compose To install docker, run: curl -fsSL https://get.docker.com -o get-docker.sh sh get-docker.sh To install docker-compose, run: sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose sudo chmod +x /usr/local/bin/docker-compose docker-compose.yml Create this docker-compose.yml with following contents: version: '3' services: db: image: mariadb command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW restart: always volumes: - /opt/nextcloud-db:/var/lib/mysql environment: - MYSQL_ROOT_PASSWORD=ENTER MYSQL PASSWORD - MYSQL_PASSWORD=ENTER MYSQL PASSWORD - MYSQL_DATABASE=nextcloud - MYSQL_USER=nextcloud redis: image: redis:alpine restart: always app: image: nextcloud:apache ports: - 8080:80 environment: - REDIS_HOST=redis depends_on: - db - redis volumes: - /opt/nextcloud-data:/var/www/html restart: always cron: image: nextcloud:apache restart: always volumes: - /opt/nextcloud-data:/var/www/html entrypoint: /cron.sh depends_on: - db - redis Run docker-compose -f docker-compose.yml up -d to start all necessary containers. Setting Up Browse to http://localhost:8080 and you’ll see a set up page like this: Fill in the fills as the following: Database user: nextcloud Database password: Enter your password in docker-compose.yml file Database name: nextcloud Database host: db After setting up nextcloud, you will see something like: Modify Overwrite Protocal Modify /opt/nextcloud-data/config/config.php and add: 'overwriteprotocol' =&amp;gt; 'https', Modify Upload Max Filesize By default, Nextcloud only allows uploading file up to 2MB which is not very useful. We can modify the max filesize by adding /opt/nextcloud-data/.htaccess with following: &amp;lt;IfModule mod_php7.c&amp;gt; ... php_value upload_max_filesize 16G php_value post_max_size 16G &amp;lt;/IfModule&amp;gt;</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jasonthai.me/assets/img/NextcloudLogo.png" /><media:content medium="image" url="https://jasonthai.me/assets/img/NextcloudLogo.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>